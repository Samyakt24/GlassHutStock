<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass HUT - Stock & Sales Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); min-height: 100vh; }
        
        .header { background: linear-gradient(135deg, #d97706, #ea580c); color: white; padding: 1rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-content { max-width: 1000px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .logo { display: flex; align-items: center; gap: 0.5rem; }
        .logo h1 { font-size: 1.3rem; }
        .logo p { font-size: 0.7rem; opacity: 0.9; }
        
        .header-btns { display: flex; gap: 0.4rem; flex-wrap: wrap; }
        .btn { padding: 0.5rem 0.9rem; border: none; border-radius: 8px; font-family: inherit; font-weight: 500; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .btn-light { background: rgba(255,255,255,0.2); color: white; }
        .btn-light:hover { background: rgba(255,255,255,0.3); }
        .btn-primary { background: linear-gradient(135deg, #f59e0b, #ea580c); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-outline { background: white; border: 2px solid #fcd34d; color: #92400e; }
        
        .tabs { background: white; border-bottom: 2px solid #fde68a; position: sticky; top: 60px; z-index: 90; }
        .tabs-content { max-width: 1000px; margin: 0 auto; display: flex; }
        .tab-btn { flex: 1; padding: 1rem; border: none; background: transparent; font-family: inherit; font-weight: 600; cursor: pointer; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab-btn:hover { background: #fffbeb; }
        .tab-btn.active { color: #d97706; border-bottom-color: #d97706; background: #fffbeb; }
        
        .main { max-width: 1000px; margin: 0 auto; padding: 1rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .sum-card { background: white; border-radius: 12px; padding: 1rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .sum-card .label { font-size: 0.75rem; color: #6b7280; }
        .sum-card .value { font-size: 1.4rem; font-weight: 700; color: #d97706; }
        .sum-card.green .value { color: #059669; }
        .sum-card.red .value { color: #dc2626; }
        .sum-card.blue .value { color: #2563eb; }
        
        .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 15px rgba(0,0,0,0.08); margin-bottom: 1rem; }
        .card-header { background: #fef3c7; padding: 1rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-body { padding: 1rem; }
        
        .form-box { background: #fffbeb; border: 2px dashed #fcd34d; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .form-box h4 { font-size: 0.95rem; color: #92400e; margin-bottom: 1rem; }
        .form-row { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 0.75rem; }
        .form-group { flex: 1; min-width: 120px; }
        .form-group label { display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.6rem; border: 2px solid #fde68a; border-radius: 8px; font-family: inherit; font-size: 0.9rem; }
        .form-group input:focus, .form-group select:focus { border-color: #f59e0b; outline: none; }
        
        .platform-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .plat-btn { padding: 0.4rem 0.8rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .plat-btn:hover { border-color: #fcd34d; }
        .plat-btn.active { border-color: #f59e0b; background: #fef3c7; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 0.65rem 0.5rem; text-align: left; border-bottom: 1px solid #fef3c7; }
        th { background: #fef3c7; font-weight: 600; color: #92400e; font-size: 0.75rem; }
        tr:hover { background: #fffbeb; }
        .low-stock { background: #fee2e2 !important; }
        
        .badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 500; }
        .badge-meesho { background: #fdf2f8; color: #be185d; }
        .badge-amazon { background: #fff7ed; color: #c2410c; }
        .badge-flipkart { background: #eff6ff; color: #1d4ed8; }
        .badge-other { background: #f3f4f6; color: #374151; }
        
        .act-btn { padding: 0.3rem 0.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin: 0 2px; transition: all 0.2s; }
        .act-btn:hover { transform: scale(1.1); }
        .act-btn.edit { background: #dbeafe; color: #1e40af; }
        .act-btn.del { background: #fee2e2; color: #991b1b; }
        .act-btn.pay { background: #d1fae5; color: #065f46; }
        
        .qty-input { width: 60px; padding: 0.25rem; border: 1px solid #fcd34d; border-radius: 4px; text-align: center; }
        
        .filters { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: center; }
        .filter-btn { padding: 0.4rem 0.8rem; border: 2px solid #fde68a; border-radius: 15px; background: white; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .filter-btn:hover { border-color: #f59e0b; }
        .filter-btn.active { background: #f59e0b; color: white; border-color: #f59e0b; }
        
        .empty { text-align: center; padding: 2rem; color: #9ca3af; }
        .loading { text-align: center; padding: 2rem; color: #f59e0b; }
        
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 1rem; }
        .modal-bg.show { display: flex; }
        .modal { background: white; border-radius: 16px; max-width: 400px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-head { padding: 1rem; background: #fef3c7; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .modal-head h3 { font-size: 1rem; color: #92400e; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 1rem; }
        
        .alert { padding: 0.75rem; border-radius: 10px; margin-bottom: 1rem; }
        .alert-danger { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; }
        .alert-success { background: #d1fae5; border: 1px solid #6ee7b7; color: #065f46; }
        
        .status-bar { background: #065f46; color: white; padding: 0.5rem 1rem; font-size: 0.75rem; text-align: center; }
        .status-bar.error { background: #991b1b; }
        .status-bar.syncing { background: #2563eb; }
        
        @media (max-width: 600px) {
            .form-row { flex-direction: column; }
            .form-group { min-width: 100%; }
            .summary { grid-template-columns: 1fr 1fr; }
            th, td { padding: 0.5rem 0.3rem; font-size: 0.75rem; }
            .header h1 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar">üîÑ Connecting to database...</div>
    
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span style="font-size:1.5rem">üíé</span>
                <div><h1>Glass HUT</h1><p>Stock & Sales Manager</p></div>
            </div>
            <div class="header-btns">
                <button class="btn btn-light" onclick="exportData()">üì• Export</button>
                <button class="btn btn-light" onclick="refreshData()">üîÑ Refresh</button>
            </div>
        </div>
    </header>
    
    <nav class="tabs">
        <div class="tabs-content">
            <button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
            <button class="tab-btn" data-tab="stock">üì¶ Stock</button>
            <button class="tab-btn" data-tab="orders">üõí Orders</button>
        </div>
    </nav>
    
    <main class="main">
        <!-- DASHBOARD -->
        <div class="tab-content active" id="tab-dashboard">
            <div class="summary">
                <div class="sum-card"><div class="label">Stock Value</div><div class="value" id="d-stock">‚Çπ0</div></div>
                <div class="sum-card"><div class="label">Total Sales</div><div class="value" id="d-sales">‚Çπ0</div></div>
                <div class="sum-card green"><div class="label">Received</div><div class="value" id="d-recv">‚Çπ0</div></div>
                <div class="sum-card red"><div class="label">Pending</div><div class="value" id="d-pend">‚Çπ0</div></div>
                <div class="sum-card blue"><div class="label">Orders</div><div class="value" id="d-ord">0</div></div>
            </div>
            <div id="alertBox"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                <div class="card">
                    <div class="card-header">üì¶ Low Stock Items</div>
                    <div class="card-body" id="dashLow"><div class="loading">Loading...</div></div>
                </div>
                <div class="card">
                    <div class="card-header">üïê Recent Orders</div>
                    <div class="card-body" id="dashRecent"><div class="loading">Loading...</div></div>
                </div>
            </div>
        </div>
        
        <!-- STOCK -->
        <div class="tab-content" id="tab-stock">
            <div class="form-box">
                <h4>‚ûï Add Stock Item</h4>
                <div class="form-row">
                    <div class="form-group"><label>Product Name *</label><input type="text" id="s-name" placeholder="Gold Bangles"></div>
                    <div class="form-group" style="max-width:100px"><label>Size</label>
                        <select id="s-size"><option>2.0</option><option>2.2</option><option selected>2.4</option><option>2.6</option><option>2.8</option><option>3.0</option></select>
                    </div>
                    <div class="form-group"><label>Color</label><input type="text" id="s-color" placeholder="Gold"></div>
                    <div class="form-group"><label>Category</label>
                        <select id="s-cat"><option>Glass</option><option>Metal</option><option>Lac</option><option>Plastic</option><option>Stone</option><option>Other</option></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Quantity *</label><input type="number" id="s-qty" min="0" placeholder="100"></div>
                    <div class="form-group"><label>Min Stock</label><input type="number" id="s-min" value="20" min="0"></div>
                    <div class="form-group"><label>Cost Price ‚Çπ *</label><input type="number" id="s-cost" min="0" step="0.01" placeholder="50"></div>
                    <div class="form-group"><label>Sell Price ‚Çπ *</label><input type="number" id="s-price" min="0" step="0.01" placeholder="100"></div>
                </div>
                <div style="text-align:right;margin-top:0.5rem">
                    <button class="btn btn-primary" id="addStockBtn">‚ûï Add Item</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><span>üì¶ Stock List</span></div>
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr><th>Product</th><th>Size</th><th>Color</th><th>Category</th><th style="text-align:center">Qty</th><th style="text-align:right">Cost</th><th style="text-align:right">Price</th><th style="text-align:right">Value</th><th>Actions</th></tr></thead>
                        <tbody id="stockTbl"><tr><td colspan="9" class="loading">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ORDERS -->
        <div class="tab-content" id="tab-orders">
            <div class="form-box">
                <h4>‚ûï Add Order</h4>
                <div class="form-row">
                    <div class="form-group"><label>Order ID *</label><input type="text" id="o-id" placeholder="MS12345"></div>
                    <div class="form-group"><label>Customer</label><input type="text" id="o-cust" placeholder="Name"></div>
                    <div class="form-group"><label>Items *</label><input type="text" id="o-items" placeholder="Gold Bangles x 6"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Amount ‚Çπ *</label><input type="number" id="o-amt" min="0" placeholder="500"></div>
                    <div class="form-group"><label>Received ‚Çπ</label><input type="number" id="o-recv" value="0" min="0"></div>
                    <div class="form-group"><label>Date</label><input type="date" id="o-date"></div>
                </div>
                <div style="margin-top:0.5rem">
                    <label style="font-size:0.75rem;color:#6b7280">Platform:</label>
                    <div class="platform-btns" style="margin-top:0.25rem">
                        <span class="plat-btn active" data-p="meesho">üõçÔ∏è Meesho</span>
                        <span class="plat-btn" data-p="amazon">üì¶ Amazon</span>
                        <span class="plat-btn" data-p="flipkart">üõí Flipkart</span>
                        <span class="plat-btn" data-p="other">üì± Other</span>
                    </div>
                </div>
                <div style="text-align:right;margin-top:0.75rem">
                    <button class="btn btn-primary" id="addOrderBtn">‚ûï Add Order</button>
                </div>
            </div>
            
            <div class="filters">
                <button class="filter-btn active" data-f="all">All</button>
                <button class="filter-btn" data-f="meesho">üõçÔ∏è Meesho</button>
                <button class="filter-btn" data-f="amazon">üì¶ Amazon</button>
                <button class="filter-btn" data-f="flipkart">üõí Flipkart</button>
                <button class="filter-btn" data-f="other">üì± Other</button>
            </div>
            
            <div class="card">
                <div class="card-header"><span>üõí Orders (<span id="ordCnt">0</span>)</span></div>
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr><th>Order ID</th><th>Customer</th><th>Items</th><th>Platform</th><th>Date</th><th style="text-align:right">Amount</th><th style="text-align:right">Received</th><th style="text-align:right">Pending</th><th>Actions</th></tr></thead>
                        <tbody id="ordTbl"><tr><td colspan="9" class="loading">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Payment Modal -->
    <div class="modal-bg" id="payModal">
        <div class="modal">
            <div class="modal-head"><h3>üí∞ Add Payment</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
                <p id="payInfo" style="margin-bottom:1rem;color:#6b7280"></p>
                <div class="form-group"><label>Amount Received ‚Çπ</label><input type="number" id="payAmt" min="0" style="width:100%"></div>
                <div style="display:flex;gap:0.5rem;margin-top:1rem">
                    <button class="btn btn-outline" onclick="closeModal()" style="flex:1">Cancel</button>
                    <button class="btn btn-success" onclick="confirmPay()" style="flex:1">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Stock Modal -->
    <div class="modal-bg" id="editModal">
        <div class="modal">
            <div class="modal-head"><h3>‚úèÔ∏è Edit Stock</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div class="form-group"><label>Product Name</label><input type="text" id="edit-name"></div>
                <div class="form-row">
                    <div class="form-group"><label>Size</label>
                        <select id="edit-size"><option>2.0</option><option>2.2</option><option>2.4</option><option>2.6</option><option>2.8</option><option>3.0</option></select>
                    </div>
                    <div class="form-group"><label>Color</label><input type="text" id="edit-color"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Quantity</label><input type="number" id="edit-qty" min="0"></div>
                    <div class="form-group"><label>Min Stock</label><input type="number" id="edit-min" min="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Cost ‚Çπ</label><input type="number" id="edit-cost" min="0" step="0.01"></div>
                    <div class="form-group"><label>Price ‚Çπ</label><input type="number" id="edit-price" min="0" step="0.01"></div>
                </div>
                <div style="display:flex;gap:0.5rem;margin-top:1rem">
                    <button class="btn btn-outline" onclick="closeModal()" style="flex:1">Cancel</button>
                    <button class="btn btn-success" onclick="saveEdit()" style="flex:1">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://fjogabazmjrzulkpihyy.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqb2dhYmF6bWpyenVsa3BpaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjQ4MDksImV4cCI6MjA4NDQwMDgwOX0.-OmFa7Hog-zBwpSE_9cjfxnBXbCjpawAtKtY-E1Ez2w';
    
    // Initialize Supabase
    const { createClient } = window.supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Data
    let stockData = [];
    let ordersData = [];
    let platform = 'meesho';
    let filterPlat = 'all';
    let payingId = null;
    
    // Status
    function setStatus(msg, type) {
        const bar = document.getElementById('statusBar');
        bar.textContent = msg;
        bar.className = 'status-bar';
        if (type === 'error') bar.classList.add('error');
        if (type === 'syncing') bar.classList.add('syncing');
    }
    
    // Load Data from Supabase
    async function loadStock() {
        try {
            const { data, error } = await db.from('stock').select('*').order('created_at', { ascending: false });
            if (error) {
                console.error('Stock error details:', error);
                throw new Error(error.message || error.details || 'Unknown error');
            }
            stockData = data || [];
            renderStock();
            renderDashboard();
            return true;
        } catch (err) {
            console.error('Load stock error:', err);
            setStatus('‚ùå Stock error: ' + err.message, 'error');
            return false;
        }
    }
    
    async function loadOrders() {
        try {
            const { data, error } = await db.from('orders').select('*').order('created_at', { ascending: false });
            if (error) {
                console.error('Orders error details:', error);
                throw new Error(error.message || error.details || 'Unknown error');
            }
            ordersData = data || [];
            renderOrders();
            renderDashboard();
            return true;
        } catch (err) {
            console.error('Load orders error:', err);
            setStatus('‚ùå Orders error: ' + err.message, 'error');
            return false;
        }
    }
    
    async function refreshData() {
        setStatus('üîÑ Syncing...', 'syncing');
        const stockOk = await loadStock();
        const ordersOk = await loadOrders();
        if (stockOk && ordersOk) {
            setStatus('‚úÖ Connected to Cloud Database');
        }
    }
    
    // Tabs
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
    });
    
    // Platform Select
    document.querySelectorAll('.plat-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.plat-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            platform = btn.dataset.p;
        });
    });
    
    // Filter
    document.querySelectorAll('.filter-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            filterPlat = btn.dataset.f;
            renderOrders();
        });
    });
    
    // Add Stock
    document.getElementById('addStockBtn').addEventListener('click', async function() {
        const name = document.getElementById('s-name').value.trim();
        const qty = document.getElementById('s-qty').value;
        const cost = document.getElementById('s-cost').value;
        const price = document.getElementById('s-price').value;
        
        if (!name) { alert('Please enter Product Name'); return; }
        if (!qty) { alert('Please enter Quantity'); return; }
        if (!cost) { alert('Please enter Cost Price'); return; }
        if (!price) { alert('Please enter Sell Price'); return; }
        
        setStatus('üîÑ Adding item...', 'syncing');
        
        try {
            const { error } = await db.from('stock').insert({
                name: name,
                size: document.getElementById('s-size').value,
                color: document.getElementById('s-color').value.trim() || null,
                category: document.getElementById('s-cat').value,
                qty: parseInt(qty),
                min_stock: parseInt(document.getElementById('s-min').value) || 20,
                cost: parseFloat(cost),
                price: parseFloat(price)
            });
            
            if (error) {
                console.error('Insert error:', error);
                throw new Error(error.message || 'Failed to add item');
            }
            
            // Clear form
            document.getElementById('s-name').value = '';
            document.getElementById('s-color').value = '';
            document.getElementById('s-qty').value = '';
            document.getElementById('s-cost').value = '';
            document.getElementById('s-price').value = '';
            
            await loadStock();
            setStatus('‚úÖ Stock item added!');
        } catch (err) {
            console.error('Add stock error:', err);
            setStatus('‚ùå Error: ' + err.message, 'error');
            alert('Error adding item: ' + err.message);
        }
    });
    
    // Add Order
    document.getElementById('addOrderBtn').addEventListener('click', async function() {
        const orderId = document.getElementById('o-id').value.trim();
        const items = document.getElementById('o-items').value.trim();
        const amt = document.getElementById('o-amt').value;
        
        if (!orderId) { alert('Please enter Order ID'); return; }
        if (!items) { alert('Please enter Items'); return; }
        if (!amt) { alert('Please enter Amount'); return; }
        
        setStatus('üîÑ Adding order...', 'syncing');
        
        try {
            const { error } = await db.from('orders').insert({
                order_id: orderId,
                customer: document.getElementById('o-cust').value.trim() || null,
                items: items,
                amount: parseFloat(amt),
                received: parseFloat(document.getElementById('o-recv').value) || 0,
                platform: platform,
                order_date: document.getElementById('o-date').value || new Date().toISOString().split('T')[0]
            });
            
            if (error) {
                console.error('Insert order error:', error);
                throw new Error(error.message || 'Failed to add order');
            }
            
            // Clear form
            document.getElementById('o-id').value = '';
            document.getElementById('o-cust').value = '';
            document.getElementById('o-items').value = '';
            document.getElementById('o-amt').value = '';
            document.getElementById('o-recv').value = '0';
            
            await loadOrders();
            setStatus('‚úÖ Order added!');
        } catch (err) {
            console.error('Add order error:', err);
            setStatus('‚ùå Error: ' + err.message, 'error');
            alert('Error adding order: ' + err.message);
        }
    });
    
    // Delete Stock
    window.delStock = async function(id) {
        if (!confirm('Delete this stock item?')) return;
        setStatus('üîÑ Deleting...', 'syncing');
        try {
            const { error } = await db.from('stock').delete().eq('id', id);
            if (error) throw new Error(error.message);
            await loadStock();
            setStatus('‚úÖ Item deleted');
        } catch (err) {
            setStatus('‚ùå Error: ' + err.message, 'error');
        }
    };
    
    // Edit Stock
    window.editStock = function(id) {
        const item = stockData.find(function(x) { return x.id === id; });
        if (!item) return;
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-name').value = item.name;
        document.getElementById('edit-size').value = item.size;
        document.getElementById('edit-color').value = item.color || '';
        document.getElementById('edit-qty').value = item.qty;
        document.getElementById('edit-min').value = item.min_stock;
        document.getElementById('edit-cost').value = item.cost;
        document.getElementById('edit-price').value = item.price;
        document.getElementById('editModal').classList.add('show');
    };
    
    window.saveEdit = async function() {
        const id = parseInt(document.getElementById('edit-id').value);
        setStatus('üîÑ Saving...', 'syncing');
        try {
            const { error } = await db.from('stock').update({
                name: document.getElementById('edit-name').value,
                size: document.getElementById('edit-size').value,
                color: document.getElementById('edit-color').value || null,
                qty: parseInt(document.getElementById('edit-qty').value),
                min_stock: parseInt(document.getElementById('edit-min').value),
                cost: parseFloat(document.getElementById('edit-cost').value),
                price: parseFloat(document.getElementById('edit-price').value)
            }).eq('id', id);
            if (error) throw new Error(error.message);
            closeModal();
            await loadStock();
            setStatus('‚úÖ Item updated');
        } catch (err) {
            setStatus('‚ùå Error: ' + err.message, 'error');
        }
    };
    
    // Update Qty inline
    window.updateQty = async function(id, val) {
        try {
            const { error } = await db.from('stock').update({ qty: parseInt(val) || 0 }).eq('id', id);
            if (error) throw new Error(error.message);
            await loadStock();
        } catch (err) {
            setStatus('‚ùå Error: ' + err.message, 'error');
        }
    };
    
    // Delete Order
    window.delOrder = async function(id) {
        if (!confirm('Delete this order?')) return;
        setStatus('üîÑ Deleting...', 'syncing');
        try {
            const { error } = await db.from('orders').delete().eq('id', id);
            if (error) throw new Error(error.message);
            await loadOrders();
            setStatus('‚úÖ Order deleted');
        } catch (err) {
            setStatus('‚ùå Error: ' + err.message, 'error');
        }
    };
    
    // Payment
    window.showPay = function(id) {
        const order = ordersData.find(function(x) { return x.id === id; });
        if (!order) return;
        payingId = id;
        const pending = order.amount - order.received;
        document.getElementById('payInfo').innerHTML = '<strong>' + order.order_id + '</strong><br>Total: ‚Çπ' + order.amount + ' | Received: ‚Çπ' + order.received + ' | Pending: ‚Çπ' + pending;
        document.getElementById('payAmt').value = pending;
        document.getElementById('payModal').classList.add('show');
    };
    
    window.confirmPay = async function() {
        const amt = parseFloat(document.getElementById('payAmt').value) || 0;
        if (amt <= 0 || !payingId) { closeModal(); return; }
        
        const order = ordersData.find(function(x) { return x.id === payingId; });
        if (!order) { closeModal(); return; }
        
        setStatus('üîÑ Updating payment...', 'syncing');
        try {
            const newReceived = Math.min(order.received + amt, order.amount);
            const { error } = await db.from('orders').update({ received: newReceived }).eq('id', payingId);
            if (error) throw new Error(error.message);
            closeModal();
            await loadOrders();
            setStatus('‚úÖ Payment updated');
        } catch (err) {
            setStatus('‚ùå Error: ' + err.message, 'error');
        }
    };
    
    window.closeModal = function() {
        document.querySelectorAll('.modal-bg').forEach(function(m) { m.classList.remove('show'); });
        payingId = null;
    };
    
    // Export
    window.exportData = function() {
        var csv = 'Type,Name/OrderID,Details,Amount,Received,Pending,Date\n';
        
        stockData.forEach(function(s) {
            csv += 'Stock,"' + s.name + '","' + s.size + ' ' + (s.color || '') + ' ' + s.category + '",' + s.qty + ',' + s.cost + ',' + s.price + ',\n';
        });
        
        ordersData.forEach(function(o) {
            csv += 'Order,"' + o.order_id + '","' + o.items + '",' + o.amount + ',' + o.received + ',' + (o.amount - o.received) + ',' + o.order_date + '\n';
        });
        
        var blob = new Blob([csv], { type: 'text/csv' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'glass-hut-export-' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
    };
    
    // Render Functions
    function renderDashboard() {
        var stockVal = stockData.reduce(function(s, x) { return s + (x.qty * x.cost); }, 0);
        var sales = ordersData.reduce(function(s, x) { return s + x.amount; }, 0);
        var recv = ordersData.reduce(function(s, x) { return s + x.received; }, 0);
        var pend = sales - recv;
        var lowStock = stockData.filter(function(x) { return x.qty <= x.min_stock; });
        
        document.getElementById('d-stock').textContent = '‚Çπ' + stockVal.toLocaleString();
        document.getElementById('d-sales').textContent = '‚Çπ' + sales.toLocaleString();
        document.getElementById('d-recv').textContent = '‚Çπ' + recv.toLocaleString();
        document.getElementById('d-pend').textContent = '‚Çπ' + pend.toLocaleString();
        document.getElementById('d-ord').textContent = ordersData.length;
        
        document.getElementById('alertBox').innerHTML = lowStock.length > 0 ?
            '<div class="alert alert-danger">‚ö†Ô∏è <strong>Low Stock:</strong> ' + lowStock.map(function(x) { return x.name + ' (' + x.qty + ')'; }).join(', ') + '</div>' : '';
        
        document.getElementById('dashLow').innerHTML = lowStock.length > 0 ?
            lowStock.slice(0, 5).map(function(x) { return '<div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #fef3c7"><span>' + x.name + '</span><span style="color:#dc2626;font-weight:600">' + x.qty + ' left</span></div>'; }).join('') :
            '<div class="empty">All stock levels OK ‚úÖ</div>';
        
        document.getElementById('dashRecent').innerHTML = ordersData.length > 0 ?
            ordersData.slice(0, 5).map(function(x) { return '<div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid #fef3c7"><span>' + x.order_id + ' <span class="badge badge-' + x.platform + '">' + x.platform + '</span></span><span style="font-weight:600">‚Çπ' + x.amount + '</span></div>'; }).join('') :
            '<div class="empty">No orders yet</div>';
    }
    
    function renderStock() {
        var html = stockData.length > 0 ?
            stockData.map(function(x) {
                var isLow = x.qty <= x.min_stock;
                return '<tr class="' + (isLow ? 'low-stock' : '') + '">' +
                    '<td><strong>' + x.name + '</strong></td>' +
                    '<td>' + x.size + '"</td>' +
                    '<td>' + (x.color || '-') + '</td>' +
                    '<td>' + x.category + '</td>' +
                    '<td style="text-align:center"><input type="number" class="qty-input" value="' + x.qty + '" onchange="updateQty(' + x.id + ', this.value)" min="0" style="' + (isLow ? 'color:#dc2626;font-weight:600' : '') + '"></td>' +
                    '<td style="text-align:right">‚Çπ' + x.cost + '</td>' +
                    '<td style="text-align:right;color:#059669">‚Çπ' + x.price + '</td>' +
                    '<td style="text-align:right;font-weight:600">‚Çπ' + (x.qty * x.cost).toLocaleString() + '</td>' +
                    '<td><button class="act-btn edit" onclick="editStock(' + x.id + ')">‚úèÔ∏è</button><button class="act-btn del" onclick="delStock(' + x.id + ')">üóëÔ∏è</button></td>' +
                    '</tr>';
            }).join('') :
            '<tr><td colspan="9" class="empty">No stock items. Add your first item above!</td></tr>';
        document.getElementById('stockTbl').innerHTML = html;
    }
    
    function renderOrders() {
        var filtered = filterPlat === 'all' ? ordersData : ordersData.filter(function(x) { return x.platform === filterPlat; });
        document.getElementById('ordCnt').textContent = filtered.length;
        
        var html = filtered.length > 0 ?
            filtered.map(function(x) {
                var pend = x.amount - x.received;
                var isPaid = pend <= 0;
                return '<tr>' +
                    '<td><strong>' + x.order_id + '</strong></td>' +
                    '<td>' + (x.customer || '-') + '</td>' +
                    '<td>' + x.items + '</td>' +
                    '<td><span class="badge badge-' + x.platform + '">' + x.platform + '</span></td>' +
                    '<td>' + x.order_date + '</td>' +
                    '<td style="text-align:right;font-weight:600">‚Çπ' + x.amount.toLocaleString() + '</td>' +
                    '<td style="text-align:right;color:#059669">‚Çπ' + x.received.toLocaleString() + '</td>' +
                    '<td style="text-align:right;color:' + (isPaid ? '#059669' : '#dc2626') + ';font-weight:500">' + (isPaid ? '‚úì Paid' : '‚Çπ' + pend.toLocaleString()) + '</td>' +
                    '<td>' + (!isPaid ? '<button class="act-btn pay" onclick="showPay(' + x.id + ')">üí∞</button>' : '') + '<button class="act-btn del" onclick="delOrder(' + x.id + ')">üóëÔ∏è</button></td>' +
                    '</tr>';
            }).join('') :
            '<tr><td colspan="9" class="empty">No orders found</td></tr>';
        document.getElementById('ordTbl').innerHTML = html;
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('o-date').value = new Date().toISOString().split('T')[0];
        refreshData();
    });
    </script>
</body>
</html>

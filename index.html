<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass HUT - Stock & Sales Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); min-height: 100vh; }
        
        .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .login-box { background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-width: 400px; width: 100%; overflow: hidden; }
        .login-header { background: linear-gradient(135deg, #d97706, #ea580c); color: white; padding: 2rem; text-align: center; }
        .login-header h1 { font-size: 1.8rem; margin-bottom: 0.25rem; }
        .login-header p { opacity: 0.9; font-size: 0.85rem; }
        .login-body { padding: 2rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.8rem; color: #6b7280; margin-bottom: 0.3rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid #fde68a; border-radius: 10px; font-family: inherit; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { border-color: #f59e0b; outline: none; }
        .login-btn { width: 100%; padding: 0.9rem; border: none; border-radius: 10px; background: linear-gradient(135deg, #d97706, #ea580c); color: white; font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 0.5rem; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(217, 119, 6, 0.4); }
        .login-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .login-error { background: #fee2e2; color: #991b1b; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; display: none; }
        
        .app-container { display: none; }
        .app-container.show { display: block; }
        .login-page.hide { display: none; }
        
        .header { background: linear-gradient(135deg, #d97706, #ea580c); color: white; padding: 1rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .logo { display: flex; align-items: center; gap: 0.5rem; }
        .logo h1 { font-size: 1.3rem; }
        .logo p { font-size: 0.7rem; opacity: 0.9; }
        .user-info { font-size: 0.8rem; opacity: 0.9; }
        
        .header-btns { display: flex; gap: 0.4rem; flex-wrap: wrap; }
        .btn { padding: 0.5rem 0.9rem; border: none; border-radius: 8px; font-family: inherit; font-weight: 500; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .btn-light { background: rgba(255,255,255,0.2); color: white; }
        .btn-light:hover { background: rgba(255,255,255,0.3); }
        .btn-primary { background: linear-gradient(135deg, #f59e0b, #ea580c); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-outline { background: white; border: 2px solid #fcd34d; color: #92400e; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.7rem; }
        .btn-warn { background: #f59e0b; color: white; }
        .btn-warn:hover { background: #d97706; }
        
        .tabs { background: white; border-bottom: 2px solid #fde68a; position: sticky; top: 60px; z-index: 90; }
        .tabs-content { max-width: 1400px; margin: 0 auto; display: flex; }
        .tab-btn { flex: 1; padding: 1rem; border: none; background: transparent; font-family: inherit; font-weight: 600; cursor: pointer; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 0.85rem; }
        .tab-btn:hover { background: #fffbeb; }
        .tab-btn.active { color: #d97706; border-bottom-color: #d97706; background: #fffbeb; }
        
        .main { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .sum-card { background: white; border-radius: 12px; padding: 0.8rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .sum-card .label { font-size: 0.65rem; color: #6b7280; }
        .sum-card .value { font-size: 1.2rem; font-weight: 700; color: #d97706; }
        .sum-card.green .value { color: #059669; }
        .sum-card.blue .value { color: #2563eb; }
        .sum-card.red .value { color: #dc2626; }
        
        .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 15px rgba(0,0,0,0.08); margin-bottom: 1rem; }
        .card-header { background: #fef3c7; padding: 1rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-body { padding: 1rem; }
        
        .form-box { background: #fffbeb; border: 2px dashed #fcd34d; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .form-box h4 { font-size: 0.95rem; color: #92400e; margin-bottom: 1rem; }
        .form-row { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 0.75rem; }
        .form-grp { flex: 1; min-width: 120px; }
        .form-grp label { display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem; }
        .form-grp input, .form-grp select { width: 100%; padding: 0.6rem; border: 2px solid #fde68a; border-radius: 8px; font-family: inherit; font-size: 0.9rem; }
        .form-grp input:focus, .form-grp select:focus { border-color: #f59e0b; outline: none; }
        
        .platform-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .plat-btn { padding: 0.4rem 0.8rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .plat-btn:hover { border-color: #fcd34d; }
        .plat-btn.active { border-color: #f59e0b; background: #fef3c7; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        th, td { padding: 0.4rem 0.3rem; text-align: left; border-bottom: 1px solid #fef3c7; }
        th { background: #fef3c7; font-weight: 600; color: #92400e; font-size: 0.65rem; position: sticky; top: 0; }
        tr:hover { background: #fffbeb; }
        .low-stock { background: #fee2e2 !important; }
        
        .badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 10px; font-size: 0.55rem; font-weight: 500; }
        .badge-meesho { background: #fdf2f8; color: #be185d; }
        .badge-amazon { background: #fff7ed; color: #c2410c; }
        .badge-flipkart { background: #eff6ff; color: #1d4ed8; }
        .badge-other { background: #f3f4f6; color: #374151; }
        .badge-delivered { background: #d1fae5; color: #065f46; }
        .badge-rto { background: #fee2e2; color: #991b1b; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-new { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .badge-dup { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        
        .act-btn { padding: 0.2rem 0.35rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.65rem; margin: 0 1px; transition: all 0.2s; }
        .act-btn:hover { transform: scale(1.1); }
        .act-btn.edit { background: #dbeafe; color: #1e40af; }
        .act-btn.del { background: #fee2e2; color: #991b1b; }
        
        .qty-input { width: 50px; padding: 0.2rem; border: 1px solid #fcd34d; border-radius: 4px; text-align: center; font-size: 0.7rem; }
        .remark-select { width: 90px; padding: 0.15rem; border: 1px solid #fcd34d; border-radius: 4px; font-size: 0.6rem; background: white; }
        
        .filters { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: center; }
        .filter-btn { padding: 0.3rem 0.6rem; border: 2px solid #fde68a; border-radius: 15px; background: white; cursor: pointer; font-size: 0.65rem; transition: all 0.2s; }
        .filter-btn:hover { border-color: #f59e0b; }
        .filter-btn.active { background: #f59e0b; color: white; border-color: #f59e0b; }
        
        .empty { text-align: center; padding: 2rem; color: #9ca3af; }
        .loading { text-align: center; padding: 2rem; color: #f59e0b; }
        
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 1rem; }
        .modal-bg.show { display: flex; }
        .modal { background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-head { padding: 1rem; background: #fef3c7; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .modal-head h3 { font-size: 1rem; color: #92400e; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 1rem; }
        
        .upload-box { border: 3px dashed #fcd34d; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .upload-box:hover { border-color: #f59e0b; background: #fffbeb; }
        .upload-box input { display: none; }
        .upload-box p { color: #6b7280; margin-top: 0.5rem; font-size: 0.8rem; }
        
        .alert { padding: 0.75rem; border-radius: 10px; margin-bottom: 1rem; font-size: 0.8rem; }
        .alert-danger { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; }
        .alert-success { background: #d1fae5; border: 1px solid #6ee7b7; color: #065f46; }
        .alert-info { background: #dbeafe; border: 1px solid #93c5fd; color: #1e40af; }
        
        .status-bar { background: #065f46; color: white; padding: 0.5rem 1rem; font-size: 0.75rem; text-align: center; }
        .status-bar.error { background: #991b1b; }
        .status-bar.syncing { background: #2563eb; }
        
        .product-cell { max-width: 150px; }
        .product-short { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: help; }
        
        .cat-chip { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 500; margin: 0.15rem; }
        .cat-light24 { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        .cat-light12 { background: #fef9c3; color: #854d0e; border: 1px solid #facc15; }
        .cat-dark24 { background: #e0e7ff; color: #3730a3; border: 1px solid #818cf8; }
        .cat-dark12 { background: #ede9fe; color: #5b21b6; border: 1px solid #a78bfa; }
        .cat-gold24 { background: #fff7ed; color: #9a3412; border: 1px solid #fb923c; }
        .cat-uncategorized { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        
        .count-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; margin: 1rem 0; }
        .count-card { background: white; border-radius: 12px; padding: 1rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid #f59e0b; }
        .count-card .cc-label { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem; }
        .count-card .cc-count { font-size: 2rem; font-weight: 700; color: #d97706; }
        .count-card .cc-sub { font-size: 0.65rem; margin-top: 0.15rem; }
        .count-card .cc-skus { font-size: 0.6rem; color: #9ca3af; margin-top: 0.25rem; max-height: 60px; overflow-y: auto; }
        
        .sku-tag { display: inline-flex; align-items: center; gap: 0.25rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; padding: 0.15rem 0.5rem; font-size: 0.7rem; margin: 0.15rem; }
        .sku-tag .remove-sku { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.8rem; padding: 0; line-height: 1; }
        .sku-tag .remove-sku:hover { color: #991b1b; }
        
        .cat-section { border: 1px solid #e5e7eb; border-radius: 10px; padding: 0.75rem; margin-bottom: 0.75rem; }
        .cat-section-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .sku-list { display: flex; flex-wrap: wrap; gap: 0.25rem; min-height: 30px; }
        
        .row-dup { background: #fef2f2 !important; }
        .row-new { background: #f0fdf4 !important; }
        
        .pdf-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 0.75rem; overflow: hidden; border-left: 4px solid #f59e0b; }
        .pdf-card-head { padding: 0.75rem 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; transition: background 0.2s; }
        .pdf-card-head:hover { background: #fffbeb; }
        .pdf-card-head .pdf-title { font-weight: 600; font-size: 0.85rem; color: #92400e; display: flex; align-items: center; gap: 0.5rem; }
        .pdf-card-head .pdf-title .arrow { transition: transform 0.3s; display: inline-block; }
        .pdf-card-head .pdf-title .arrow.open { transform: rotate(90deg); }
        .pdf-card-head .pdf-stats { display: flex; gap: 0.75rem; font-size: 0.7rem; }
        .pdf-card-head .stat-pill { padding: 0.2rem 0.5rem; border-radius: 10px; font-weight: 500; }
        .pdf-card-head .stat-total { background: #f3f4f6; color: #374151; }
        .pdf-card-head .stat-new { background: #d1fae5; color: #065f46; }
        .pdf-card-head .stat-dup { background: #fee2e2; color: #991b1b; }
        .pdf-card-body { display: none; border-top: 1px solid #fef3c7; padding: 1rem; }
        .pdf-card-body.open { display: block; }
        .pdf-card-actions { display: flex; gap: 0.3rem; }
        
        .dup-summary { display: flex; gap: 1rem; flex-wrap: wrap; padding: 0.75rem; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 1rem; align-items: center; }
        .dup-stat { text-align: center; padding: 0.5rem 1rem; border-radius: 10px; min-width: 100px; }
        .dup-stat .ds-num { font-size: 1.5rem; font-weight: 700; }
        .dup-stat .ds-label { font-size: 0.65rem; color: #6b7280; }
        .dup-stat.total { background: #f3f4f6; }
        .dup-stat.total .ds-num { color: #374151; }
        .dup-stat.new-stat { background: #d1fae5; }
        .dup-stat.new-stat .ds-num { color: #059669; }
        .dup-stat.dup-stat-bg { background: #fee2e2; }
        .dup-stat.dup-stat-bg .ds-num { color: #dc2626; }
        
        @media (max-width: 768px) {
            .form-row { flex-direction: column; }
            .form-grp { min-width: 100%; }
            .summary { grid-template-columns: 1fr 1fr; }
            th, td { padding: 0.25rem 0.15rem; font-size: 0.6rem; }
            .header h1 { font-size: 1rem; }
            .product-cell { max-width: 70px; }
            .remark-select { width: 65px; }
            .count-grid { grid-template-columns: 1fr 1fr; }
            .tab-btn { font-size: 0.7rem; padding: 0.75rem 0.25rem; }
            .dup-summary { gap: 0.5rem; }
            .dup-stat { min-width: 80px; padding: 0.4rem 0.6rem; }
            .dup-stat .ds-num { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="login-page" id="loginPage">
        <div class="login-box">
            <div class="login-header">
                <div style="font-size:3rem;margin-bottom:0.5rem">üíé</div>
                <h1>Glass HUT</h1>
                <p>Stock & Sales Manager</p>
            </div>
            <div class="login-body">
                <div class="login-error" id="loginError"></div>
                <div class="form-group"><label>Email</label><input type="email" id="loginEmail" placeholder="your@email.com"></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button class="login-btn" id="loginBtn" onclick="doLogin()">Login</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="status-bar" id="statusBar">üîÑ Connecting...</div>
        <header class="header">
            <div class="header-content">
                <div class="logo"><span style="font-size:1.5rem">üíé</span><div><h1>Glass HUT</h1><p>Stock & Sales Manager</p></div></div>
                <div class="header-btns">
                    <span class="user-info" id="userEmail"></span>
                    <button class="btn btn-light" onclick="exportData()">üì• Export</button>
                    <button class="btn btn-light" onclick="refreshData()">üîÑ</button>
                    <button class="btn btn-light" onclick="doLogout()">üö™</button>
                </div>
            </div>
        </header>
        <nav class="tabs"><div class="tabs-content">
            <button class="tab-btn active" data-tab="dashboard">üìä Dash</button>
            <button class="tab-btn" data-tab="stock">üì¶ Stock</button>
            <button class="tab-btn" data-tab="orders">üõí Orders</button>
            <button class="tab-btn" data-tab="sku">üè∑Ô∏è SKU</button>
            <button class="tab-btn" data-tab="labels">üìÑ Labels</button>
        </div></nav>
        
        <main class="main">
            <!-- DASHBOARD -->
            <div class="tab-content active" id="tab-dashboard">
                <div class="summary">
                    <div class="sum-card"><div class="label">Stock Value</div><div class="value" id="d-stock">‚Çπ0</div></div>
                    <div class="sum-card"><div class="label">Total Sales</div><div class="value" id="d-sales">‚Çπ0</div></div>
                    <div class="sum-card green"><div class="label">Received</div><div class="value" id="d-recv">‚Çπ0</div></div>
                    <div class="sum-card blue"><div class="label">Delivered</div><div class="value" id="d-del">0</div></div>
                    <div class="sum-card red"><div class="label">RTO</div><div class="value" id="d-rto">0</div></div>
                </div>
                <div id="alertBox"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                    <div class="card"><div class="card-header">üì¶ Low Stock</div><div class="card-body" id="dashLow"><div class="loading">Loading...</div></div></div>
                    <div class="card"><div class="card-header">üïê Recent Orders</div><div class="card-body" id="dashRecent"><div class="loading">Loading...</div></div></div>
                </div>
            </div>
            
            <!-- STOCK -->
            <div class="tab-content" id="tab-stock">
                <div class="form-box">
                    <h4>‚ûï Add Stock Item</h4>
                    <div class="form-row">
                        <div class="form-grp"><label>Product Name *</label><input type="text" id="s-name" placeholder="Glass Bangles"></div>
                        <div class="form-grp" style="max-width:100px"><label>Size *</label><select id="s-size"><option>2.0</option><option>2.1</option><option>2.2</option><option>2.3</option><option selected>2.4</option><option>2.5</option><option>2.6</option><option>2.7</option><option>2.8</option><option>2.9</option><option>2.10</option><option>2.11</option><option>2.12</option></select></div>
                        <div class="form-grp"><label>Quantity *</label><input type="number" id="s-qty" min="0" placeholder="100"></div>
                        <div class="form-grp"><label>Cost ‚Çπ *</label><input type="number" id="s-cost" min="0" step="0.01" placeholder="50"></div>
                        <div class="form-grp"><label>Price ‚Çπ *</label><input type="number" id="s-price" min="0" step="0.01" placeholder="100"></div>
                    </div>
                    <div style="text-align:right;margin-top:0.5rem"><button class="btn btn-primary" id="addStockBtn">‚ûï Add</button></div>
                </div>
                <div class="card">
                    <div class="card-header"><span>üì¶ Stock (<span id="stockCnt">0</span>)</span></div>
                    <div style="overflow-x:auto"><table>
                        <thead><tr><th>Product</th><th>Size</th><th>Qty</th><th>Cost</th><th>Price</th><th>Value</th><th>Act</th></tr></thead>
                        <tbody id="stockTbl"><tr><td colspan="7" class="loading">Loading...</td></tr></tbody>
                    </table></div>
                </div>
            </div>
            
            <!-- ORDERS -->
            <div class="tab-content" id="tab-orders">
                <div class="form-box">
                    <h4>üìä Import Meesho File (Excel or CSV)</h4>
                    <div class="upload-box" onclick="document.getElementById('excelFile').click()">
                        <div style="font-size:2rem">üìÅ</div>
                        <p><strong>Click to upload</strong><br>Excel (.xlsx) or CSV (.csv)</p>
                        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(this)">
                    </div>
                    <div id="importStatus" style="margin-top:0.75rem"></div>
                </div>
                <div class="form-box">
                    <h4>‚ûï Add Order Manually</h4>
                    <div class="form-row">
                        <div class="form-grp"><label>Order ID *</label><input type="text" id="o-id" placeholder="MS12345"></div>
                        <div class="form-grp"><label>Customer</label><input type="text" id="o-cust" placeholder="Name"></div>
                        <div class="form-grp"><label>State</label><input type="text" id="o-state" placeholder="Delhi"></div>
                        <div class="form-grp"><label>Date</label><input type="date" id="o-date"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-grp" style="flex:2"><label>Item *</label><select id="o-item"><option value="">-- Select --</option></select></div>
                        <div class="form-grp" style="max-width:80px"><label>Size *</label><select id="o-size"><option>2.0</option><option>2.1</option><option>2.2</option><option>2.3</option><option selected>2.4</option><option>2.5</option><option>2.6</option><option>2.7</option><option>2.8</option><option>2.9</option><option>2.10</option><option>2.11</option><option>2.12</option></select></div>
                        <div class="form-grp" style="max-width:60px"><label>Qty *</label><input type="number" id="o-qty" min="1" value="1"></div>
                        <div class="form-grp"><label>Amount ‚Çπ *</label><input type="number" id="o-amt" min="0"></div>
                        <div class="form-grp"><label>Received ‚Çπ</label><input type="number" id="o-recv" value="0" min="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-grp" style="max-width:120px"><label>Status</label><select id="o-status"><option value="Pending">Pending</option><option value="Delivered">Delivered</option><option value="RTO">RTO</option></select></div>
                        <div class="form-grp"><label>Platform</label>
                            <div class="platform-btns" style="margin-top:0.25rem">
                                <span class="plat-btn active" data-p="meesho">üõçÔ∏è Meesho</span>
                                <span class="plat-btn" data-p="amazon">üì¶ Amazon</span>
                                <span class="plat-btn" data-p="flipkart">üõí Flipkart</span>
                                <span class="plat-btn" data-p="other">üì± Other</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:right;margin-top:0.5rem"><button class="btn btn-primary" id="addOrderBtn">‚ûï Add</button></div>
                </div>
                <div class="filters">
                    <span style="font-size:0.65rem;color:#6b7280">Platform:</span>
                    <button class="filter-btn active" data-f="all">All</button>
                    <button class="filter-btn" data-f="meesho">Meesho</button>
                    <button class="filter-btn" data-f="amazon">Amazon</button>
                    <button class="filter-btn" data-f="flipkart">Flipkart</button>
                    <span style="margin-left:0.5rem;font-size:0.65rem;color:#6b7280">Status:</span>
                    <button class="filter-btn" data-s="Delivered">‚úÖ</button>
                    <button class="filter-btn" data-s="RTO">üîÑ</button>
                    <button class="filter-btn" data-s="Pending">‚è≥</button>
                </div>
                <div class="card">
                    <div class="card-header"><span>üõí Orders (<span id="ordCnt">0</span>)</span></div>
                    <div style="overflow-x:auto;max-height:450px"><table>
                        <thead><tr><th>Order ID</th><th>Product</th><th>SKU/Stock</th><th>Size</th><th>Qty</th><th>State</th><th>Platform</th><th>Status</th><th>Date</th><th>Amount</th><th>Received</th><th>X</th></tr></thead>
                        <tbody id="ordTbl"><tr><td colspan="12" class="loading">Loading...</td></tr></tbody>
                    </table></div>
                </div>
            </div>
            
            <!-- SKU -->
            <div class="tab-content" id="tab-sku">
                <div class="form-box">
                    <h4>üè∑Ô∏è Add SKU to Category</h4>
                    <p style="font-size:0.75rem;color:#6b7280;margin-bottom:1rem">Add Meesho SKU names and assign them to categories. Used when counting labels from PDF.</p>
                    <div class="form-row">
                        <div class="form-grp" style="flex:2"><label>SKU Name *</label><input type="text" id="sku-name" placeholder="e.g. GLASS-BANGLE-LM-24-RED"></div>
                        <div class="form-grp"><label>Category *</label><select id="sku-cat">
                            <option value="Light Multi 24">Light Multi 24</option>
                            <option value="Light Multi 12">Light Multi 12</option>
                            <option value="Dark Multi 24">Dark Multi 24</option>
                            <option value="Dark Multi 12">Dark Multi 12</option>
                            <option value="GOLD Multi 24">GOLD Multi 24</option>
                        </select></div>
                    </div>
                    <div style="display:flex;gap:0.5rem;justify-content:flex-end;margin-top:0.5rem"><button class="btn btn-primary" onclick="addSku()">‚ûï Add SKU</button></div>
                </div>
                <div class="card">
                    <div class="card-header"><span>üè∑Ô∏è SKU Mappings (<span id="skuCnt">0</span>)</span></div>
                    <div class="card-body" id="skuContainer"><div class="loading">Loading...</div></div>
                </div>
            </div>
            
            <!-- LABELS -->
            <div class="tab-content" id="tab-labels">
                <div class="form-box">
                    <h4>üìÑ Upload Meesho Label PDF</h4>
                    <p style="font-size:0.75rem;color:#6b7280;margin-bottom:0.5rem">Upload label PDFs. Each upload appears as a card below. Click to expand details. Duplicates auto-detected.</p>
                    <div class="upload-box" onclick="document.getElementById('pdfFile').click()">
                        <div style="font-size:2rem">üìÑ</div>
                        <p><strong>Click to upload Label PDF</strong><br>PDF file (.pdf)</p>
                        <input type="file" id="pdfFile" accept=".pdf" onchange="handlePdfUpload(this)">
                    </div>
                    <div id="pdfStatus" style="margin-top:0.75rem"></div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;flex-wrap:wrap;gap:0.5rem">
                    <h4 style="font-size:0.9rem;color:#92400e">üìã Upload History</h4>
                    <div style="display:flex;gap:0.4rem">
                        <button class="btn btn-danger btn-sm" onclick="clearAllUploads()" title="Delete all upload history">üóëÔ∏è Clear All</button>
                        <button class="btn btn-danger btn-sm" onclick="clearScanHistory()" title="Reset duplicate detection">üîÅ Reset Dup History</button>
                    </div>
                </div>
                <div id="pdfHistoryList"><div class="empty">No PDFs uploaded yet. Upload one above!</div></div>
            </div>
        </main>
    </div>
    
    <div class="modal-bg" id="editModal">
        <div class="modal">
            <div class="modal-head"><h3>‚úèÔ∏è Edit Stock</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div class="form-group"><label>Product Name</label><input type="text" id="edit-name"></div>
                <div class="form-row">
                    <div class="form-grp"><label>Size</label><select id="edit-size"><option>2.0</option><option>2.1</option><option>2.2</option><option>2.3</option><option>2.4</option><option>2.5</option><option>2.6</option><option>2.7</option><option>2.8</option><option>2.9</option><option>2.10</option><option>2.11</option><option>2.12</option></select></div>
                    <div class="form-grp"><label>Quantity</label><input type="number" id="edit-qty" min="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-grp"><label>Cost ‚Çπ</label><input type="number" id="edit-cost" min="0" step="0.01"></div>
                    <div class="form-grp"><label>Price ‚Çπ</label><input type="number" id="edit-price" min="0" step="0.01"></div>
                </div>
                <div style="display:flex;gap:0.5rem;margin-top:1rem">
                    <button class="btn btn-outline" onclick="closeModal()" style="flex:1">Cancel</button>
                    <button class="btn btn-success" onclick="saveEdit()" style="flex:1">Save</button>
                </div>
            </div>
        </div>
    </div>

<script>
const SUPABASE_URL='https://fjogabazmjrzulkpihyy.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqb2dhYmF6bWpyenVsa3BpaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjQ4MDksImV4cCI6MjA4NDQwMDgwOX0.-OmFa7Hog-zBwpSE_9cjfxnBXbCjpawAtKtY-E1Ez2w';
const{createClient}=window.supabase;const db=createClient(SUPABASE_URL,SUPABASE_KEY);
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const CATEGORIES=['Light Multi 24','Light Multi 12','Dark Multi 24','Dark Multi 12','GOLD Multi 24'];
const CAT_COLORS={'Light Multi 24':'cat-light24','Light Multi 12':'cat-light12','Dark Multi 24':'cat-dark24','Dark Multi 12':'cat-dark12','GOLD Multi 24':'cat-gold24','Uncategorized':'cat-uncategorized'};

let stockData=[],ordersData=[],skuData=[],scanHistory=[];
let platform='meesho',filterPlat='all',filterStatus='all',currentUser=null;

// AUTH
function showError(msg){var el=document.getElementById('loginError');el.textContent=msg;el.style.display='block';}
async function doLogin(){
    var email=document.getElementById('loginEmail').value.trim(),password=document.getElementById('loginPassword').value;
    if(!email||!password){showError('Enter email and password');return;}
    document.getElementById('loginBtn').disabled=true;document.getElementById('loginBtn').textContent='Logging in...';
    document.getElementById('loginError').style.display='none';
    try{var r=await db.auth.signInWithPassword({email,password});if(r.error)throw new Error(r.error.message);currentUser=r.data.user;showApp();}catch(err){showError(err.message);}
    document.getElementById('loginBtn').disabled=false;document.getElementById('loginBtn').textContent='Login';
}
async function doLogout(){await db.auth.signOut();currentUser=null;document.getElementById('loginPage').classList.remove('hide');document.getElementById('appContainer').classList.remove('show');}
function showApp(){document.getElementById('loginPage').classList.add('hide');document.getElementById('appContainer').classList.add('show');document.getElementById('userEmail').textContent='üë§ '+currentUser.email;document.getElementById('o-date').value=new Date().toISOString().split('T')[0];refreshData();loadPdfHistory();}
async function checkAuth(){var r=await db.auth.getSession();if(r.data.session){currentUser=r.data.session.user;showApp();}}
function setStatus(msg,type){var bar=document.getElementById('statusBar');bar.textContent=msg;bar.className='status-bar'+(type==='error'?' error':type==='syncing'?' syncing':'');}

// DATA
async function loadStock(){try{var r=await db.from('stock').select('*').order('created_at',{ascending:false});if(r.error)throw new Error(r.error.message);stockData=r.data||[];renderStock();renderDashboard();populateItemDropdown();return true;}catch(err){setStatus('‚ùå '+err.message,'error');return false;}}
async function loadOrders(){try{var r=await db.from('orders').select('*').order('created_at',{ascending:false});if(r.error)throw new Error(r.error.message);ordersData=r.data||[];renderOrders();renderDashboard();return true;}catch(err){setStatus('‚ùå '+err.message,'error');return false;}}
async function loadSkus(){try{var r=await db.from('sku_map').select('*').order('category',{ascending:true});if(r.error){if(r.error.message.includes('does not exist')||r.error.code==='42P01'){skuData=[];renderSkus();document.getElementById('skuContainer').innerHTML='<div class="alert alert-danger">‚ö†Ô∏è Table <b>sku_map</b> not found. Create it in Supabase SQL Editor.</div>';return true;}throw new Error(r.error.message);}skuData=r.data||[];renderSkus();return true;}catch(err){skuData=[];renderSkus();return true;}}
async function loadScanHistory(){try{var r=await db.from('scan_history').select('*');if(r.error){if(r.error.message.includes('does not exist')||r.error.code==='42P01'){scanHistory=[];return true;}throw new Error(r.error.message);}scanHistory=r.data||[];return true;}catch(err){scanHistory=[];return true;}}
async function refreshData(){setStatus('üîÑ Syncing...','syncing');var s=await loadStock(),o=await loadOrders();await loadSkus();await loadScanHistory();if(s&&o)setStatus('‚úÖ Connected');}

// SKU CRUD
async function addSku(){
    var skuName=document.getElementById('sku-name').value.trim(),category=document.getElementById('sku-cat').value;
    if(!skuName){alert('Enter SKU name');return;}
    if(skuData.find(function(s){return normSku(s.sku_name)===normSku(skuName);})){alert('SKU already exists!');return;}
    setStatus('üîÑ Adding SKU...','syncing');
    try{var r=await db.from('sku_map').insert({sku_name:skuName,category:category});if(r.error)throw new Error(r.error.message);document.getElementById('sku-name').value='';await loadSkus();if(pdfUploads.length>0)renderPdfHistory();setStatus('‚úÖ SKU added!');}catch(err){setStatus('‚ùå '+err.message,'error');alert('Error: '+err.message);}
}
window.addSku=addSku;
window.deleteSku=async function(id){if(!confirm('Remove this SKU?'))return;try{await db.from('sku_map').delete().eq('id',id);await loadSkus();setStatus('‚úÖ SKU removed');}catch(err){setStatus('‚ùå '+err.message,'error');}};
window.quickAssignSku=async function(skuName){
    var el=document.querySelector('[data-assign-sku="'+CSS.escape(skuName)+'"]');if(!el)return;
    var cat=el.value;if(!cat){alert('Select category first');return;}
    if(skuData.find(function(s){return normSku(s.sku_name)===normSku(skuName);})){alert('Already mapped!');return;}
    try{var r=await db.from('sku_map').insert({sku_name:skuName,category:cat});if(r.error)throw new Error(r.error.message);await loadSkus();if(lastPdfLabels.length>0)renderPdfResults();setStatus('‚úÖ SKU mapped!');}catch(err){setStatus('‚ùå '+err.message,'error');}
};

function renderSkus(){
    document.getElementById('skuCnt').textContent=skuData.length;
    var c=document.getElementById('skuContainer');
    if(skuData.length===0){c.innerHTML='<div class="empty">No SKU mappings yet.</div>';return;}
    var grouped={};CATEGORIES.forEach(function(cat){grouped[cat]=[];});
    skuData.forEach(function(s){if(!grouped[s.category])grouped[s.category]=[];grouped[s.category].push(s);});
    var html='';
    CATEGORIES.forEach(function(cat){
        var items=grouped[cat]||[];
        html+='<div class="cat-section"><div class="cat-section-head"><h5><span class="cat-chip '+CAT_COLORS[cat]+'">'+cat+'</span> <span style="font-size:0.75rem;color:#9ca3af">('+items.length+')</span></h5></div><div class="sku-list">';
        if(items.length===0){html+='<span style="font-size:0.7rem;color:#d1d5db;padding:0.25rem">No SKUs</span>';}
        else{items.forEach(function(s){html+='<span class="sku-tag">'+escapeHtml(s.sku_name)+' <button class="remove-sku" onclick="deleteSku('+s.id+')" title="Remove">√ó</button></span>';});}
        html+='</div></div>';
    });
    c.innerHTML=html;
}

// PDF PARSING ‚Äî Card-based history
var pdfUploads=[]; // [{id,name,date,labels:[{orderId,sku,isDuplicate,page}]}]
var openCardId=null;

// Save PDF upload to Supabase
async function savePdfUpload(upload){
    try{var r=await db.from('pdf_uploads').insert({file_name:upload.name,upload_date:new Date().toISOString(),labels:upload.labels,new_count:upload.newCount,dup_count:upload.dupCount});
        if(r.error)throw new Error(r.error.message);
    }catch(err){console.error('Save PDF error:',err);}}
// Load all PDF uploads from Supabase
async function loadPdfHistory(){
    try{var r=await db.from('pdf_uploads').select('*').order('created_at',{ascending:false});
        if(r.error){if(r.error.message.includes('does not exist')||r.error.code==='42P01'){pdfUploads=[];renderPdfHistory();return;}throw new Error(r.error.message);}
        pdfUploads=(r.data||[]).map(function(row){return{id:row.id,name:row.file_name,date:new Date(row.upload_date).toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}),labels:row.labels||[],newCount:row.new_count||0,dupCount:row.dup_count||0};});
        renderPdfHistory();
    }catch(err){pdfUploads=[];renderPdfHistory();}}

window.handlePdfUpload=async function(input){
    var file=input.files[0];if(!file)return;
    var statusDiv=document.getElementById('pdfStatus');
    statusDiv.innerHTML='<div class="alert alert-info">üìÑ Reading "'+escapeHtml(file.name)+'"... Please wait.</div>';
    setStatus('üîÑ Parsing PDF...','syncing');
    try{
        await loadScanHistory();
        var arrayBuffer=await file.arrayBuffer();
        var pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
        var labels=[];
        for(var i=1;i<=pdf.numPages;i++){
            var page=await pdf.getPage(i);
            var tc=await page.getTextContent();
            var items=tc.items.map(function(it){return it.str;});
            var pageText=items.join(' ');
            var orderId=extractOrderId(pageText,items);
            var sku=extractSku(pageText,items);
            var size=extractSize(pageText,items);
            if(orderId||sku){
                var isDup=orderId?scanHistory.some(function(h){return h.order_id===orderId;}):false;
                labels.push({orderId:orderId||'Unknown-P'+i,sku:sku||'Unknown',size:size||'-',isDuplicate:isDup,page:i});
            }
        }
        if(labels.length===0){statusDiv.innerHTML='<div class="alert alert-danger">‚ùå No labels found in "'+escapeHtml(file.name)+'".</div>';setStatus('‚ùå No labels','error');input.value='';return;}
        // Auto-save new order IDs to scan_history
        var newToSave=labels.filter(function(l){return !l.isDuplicate&&l.orderId&&!l.orderId.startsWith('Unknown');});
        if(newToSave.length>0){
            var today=new Date().toISOString().split('T')[0];
            var ins=newToSave.map(function(l){return{order_id:l.orderId,sku:l.sku,scanned_date:today};});
            for(var b=0;b<ins.length;b+=50){var batch=ins.slice(b,b+50);await db.from('scan_history').insert(batch);}
            await loadScanHistory();
        }
        var nw=labels.filter(function(l){return !l.isDuplicate;}).length;
        var dp=labels.filter(function(l){return l.isDuplicate;}).length;
        // Save to Supabase
        var upload={name:file.name,labels:labels,newCount:nw,dupCount:dp};
        await savePdfUpload(upload);
        await loadPdfHistory();
        // Auto-open latest
        if(pdfUploads.length>0)openCardId=pdfUploads[0].id;
        renderPdfHistory();
        statusDiv.innerHTML='<div class="alert alert-success">‚úÖ <b>'+labels.length+'</b> labels found ‚Äî <span style="color:#059669"><b>'+nw+' new</b></span>'+(dp>0?', <span style="color:#dc2626"><b>'+dp+' duplicate</b></span>':'')+'</div>';
        setStatus('‚úÖ PDF parsed!');input.value='';
    }catch(err){statusDiv.innerHTML='<div class="alert alert-danger">‚ùå '+err.message+'</div>';setStatus('‚ùå PDF error','error');input.value='';}
};

window.togglePdfCard=function(id){openCardId=(openCardId===id)?null:id;renderPdfHistory();};
window.deleteUpload=async function(id){if(!confirm('Delete this upload?'))return;
    try{await db.from('pdf_uploads').delete().eq('id',id);if(openCardId===id)openCardId=null;await loadPdfHistory();setStatus('‚úÖ Deleted');}catch(err){setStatus('‚ùå '+err.message,'error');}};
window.clearAllUploads=async function(){if(!confirm('Delete ALL upload history?'))return;
    try{await db.from('pdf_uploads').delete().neq('id',0);pdfUploads=[];openCardId=null;renderPdfHistory();setStatus('‚úÖ All cleared');}catch(err){setStatus('‚ùå '+err.message,'error');}};
window.clearScanHistory=async function(){
    if(!confirm('‚ö†Ô∏è Delete ALL duplicate detection history?\nAll labels will show as "New" next time.'))return;
    setStatus('üîÑ Clearing...','syncing');
    try{var r=await db.from('scan_history').delete().neq('id',0);if(r.error)throw new Error(r.error.message);scanHistory=[];setStatus('‚úÖ Dup history cleared!');}catch(err){setStatus('‚ùå '+err.message,'error');}
};

function renderPdfHistory(){
    var container=document.getElementById('pdfHistoryList');
    if(pdfUploads.length===0){container.innerHTML='<div class="empty">No PDFs uploaded yet. Upload one above!</div>';return;}
    var html='';
    pdfUploads.forEach(function(u){
        var isOpen=openCardId===u.id;
        var total=u.labels.length;
        html+='<div class="pdf-card">';
        html+='<div class="pdf-card-head" onclick="togglePdfCard('+u.id+')">';
        html+='<div class="pdf-title"><span class="arrow'+(isOpen?' open':'')+'">‚ñ∂</span> üìÑ '+escapeHtml(u.name)+'</div>';
        html+='<div class="pdf-stats">';
        html+='<span style="font-size:0.65rem;color:#9ca3af">'+u.date+'</span>';
        html+='<span class="stat-pill stat-total">'+total+' labels</span>';
        html+='<span class="stat-pill stat-new">üì¶ Pack: '+u.newCount+'</span>';
        if(u.dupCount>0)html+='<span class="stat-pill stat-dup">üîÅ Old: '+u.dupCount+'</span>';
        html+='<div class="pdf-card-actions"><button class="act-btn del" onclick="event.stopPropagation();deleteUpload('+u.id+')" title="Delete">üóëÔ∏è</button></div>';
        html+='</div></div>';
        html+='<div class="pdf-card-body'+(isOpen?' open':'')+'" id="pdfBody-'+u.id+'">';
        if(isOpen)html+=buildCardDetails(u);
        html+='</div></div>';
    });
    container.innerHTML=html;
}

function buildCardDetails(upload){
    var all=upload.labels;
    var newLabels=all.filter(function(l){return !l.isDuplicate;});
    var dupLabels=all.filter(function(l){return l.isDuplicate;});
    var html='';
    // Category counts for NEW only (what to pack)
    var packCounts={};var allCounts={};
    CATEGORIES.forEach(function(c){packCounts[c]={count:0,skus:[],sizes:{}};allCounts[c]={total:0,newC:0,dupC:0};});
    packCounts['Uncategorized']={count:0,skus:[],sizes:{}};allCounts['Uncategorized']={total:0,newC:0,dupC:0};
    var unmapped=[];
    all.forEach(function(l){
        var match=findCategory(l.sku);
        var cat=match?match.category:'Uncategorized';
        if(!match&&l.sku!=='Unknown'&&!unmapped.find(function(u){return normSku(u)===normSku(l.sku);}))unmapped.push(l.sku);
        if(!allCounts[cat])allCounts[cat]={total:0,newC:0,dupC:0};
        allCounts[cat].total++;
        if(l.isDuplicate){allCounts[cat].dupC++;}
        else{
            allCounts[cat].newC++;
            if(!packCounts[cat])packCounts[cat]={count:0,skus:[],sizes:{}};
            packCounts[cat].count++;
            if(packCounts[cat].skus.indexOf(l.sku)===-1)packCounts[cat].skus.push(l.sku);
            var sz=l.size||'-';
            packCounts[cat].sizes[sz]=(packCounts[cat].sizes[sz]||0)+1;
        }
    });
    // Unmapped SKU warning
    if(unmapped.length>0){
        html+='<div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;padding:0.6rem;margin-bottom:0.75rem;font-size:0.7rem;color:#92400e">‚ö†Ô∏è <b>'+unmapped.length+' SKU(s) not mapped</b> ‚Äî go to <b>SKU tab</b> to assign: '+unmapped.map(function(s){return'<b>'+escapeHtml(s)+'</b>';}).join(', ')+'</div>';
    }
    // ===== PACK TODAY section =====
    var totalPack=newLabels.length;
    html+='<div style="background:linear-gradient(135deg,#d1fae5,#ecfdf5);border:2px solid #6ee7b7;border-radius:12px;padding:1rem;margin-bottom:1rem">';
    html+='<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.75rem">';
    html+='<div style="font-weight:700;font-size:1rem;color:#065f46">üì¶ PACK TODAY: <span style="font-size:1.3rem">'+totalPack+'</span> orders</div>';
    if(dupLabels.length>0)html+='<div style="font-size:0.7rem;color:#991b1b;background:#fee2e2;padding:0.25rem 0.6rem;border-radius:8px">üîÅ '+dupLabels.length+' already packed (skipped)</div>';
    html+='</div>';
    if(totalPack>0){
        html+='<div class="count-grid" style="margin:0">';
        CATEGORIES.concat(['Uncategorized']).forEach(function(cat){
            var d=packCounts[cat];if(!d||d.count===0)return;
            var bc='#10b981';if(cat.includes('Light'))bc='#eab308';if(cat.includes('Dark'))bc='#818cf8';if(cat.includes('GOLD'))bc='#fb923c';if(cat==='Uncategorized')bc='#9ca3af';
            html+='<div class="count-card" style="border-left-color:'+bc+';background:#fff"><div class="cc-label">'+cat+'</div><div class="cc-count" style="color:'+bc+'">'+d.count+'</div>';
            // Size breakdown
            var sizes=Object.keys(d.sizes).sort();
            if(sizes.length>0){
                html+='<div style="margin-top:0.3rem;font-size:0.65rem;color:#374151">';
                sizes.forEach(function(sz){html+='<span style="display:inline-block;background:#f3f4f6;border-radius:4px;padding:0.1rem 0.4rem;margin:0.1rem;font-weight:500">'+sz+'" √ó '+d.sizes[sz]+'</span>';});
                html+='</div>';
            }
            html+='<div class="cc-skus">'+d.skus.join(', ')+'</div></div>';
        });
        html+='</div>';
    }else{
        html+='<div style="text-align:center;padding:0.5rem;color:#065f46;font-size:0.85rem">‚úÖ All orders already packed! Nothing new to pack.</div>';
    }
    html+='</div>';
    // ===== Full breakdown (collapsible) =====
    html+='<details style="margin-bottom:0.75rem"><summary style="cursor:pointer;font-weight:600;font-size:0.8rem;color:#92400e;padding:0.5rem 0">üìä Full Breakdown (All '+all.length+' labels)</summary>';
    html+='<div class="count-grid" style="margin-top:0.5rem">';
    CATEGORIES.concat(['Uncategorized']).forEach(function(cat){
        var d=allCounts[cat];if(!d||d.total===0)return;
        var bc='#f59e0b';if(cat.includes('Light'))bc='#eab308';if(cat.includes('Dark'))bc='#818cf8';if(cat.includes('GOLD'))bc='#fb923c';if(cat==='Uncategorized')bc='#9ca3af';
        html+='<div class="count-card" style="border-left-color:'+bc+'"><div class="cc-label">'+cat+'</div><div class="cc-count">'+d.total+'</div>';
        html+='<div class="cc-sub"><span style="color:#059669">üÜï '+d.newC+'</span> <span style="color:#dc2626">üîÅ '+d.dupC+'</span></div></div>';
    });
    html+='</div></details>';
    // ===== Label detail table (no assign column) =====
    html+='<details><summary style="cursor:pointer;font-weight:600;font-size:0.8rem;color:#92400e;padding:0.5rem 0">üìã All Labels ('+all.length+')</summary>';
    html+='<div style="overflow-x:auto;max-height:350px;margin-top:0.5rem"><table><thead><tr><th>Order ID</th><th>SKU</th><th>Size</th><th>Category</th><th>Status</th></tr></thead><tbody>';
    all.forEach(function(l){
        var match=findCategory(l.sku);
        var catLabel=match?'<span class="cat-chip '+(CAT_COLORS[match.category]||'cat-uncategorized')+'">'+match.category+'</span>':'<span class="cat-chip cat-uncategorized">Uncategorized</span>';
        var statusBadge=l.isDuplicate?'<span class="badge badge-dup">üîÅ OLD</span>':'<span class="badge badge-new">üÜï NEW</span>';
        var rowClass=l.isDuplicate?'row-dup':'row-new';
        html+='<tr class="'+rowClass+'"><td style="font-size:0.55rem;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+escapeAttr(l.orderId)+'">'+escapeHtml(l.orderId)+'</td><td style="font-size:0.6rem"><b>'+escapeHtml(l.sku)+'</b></td><td style="font-weight:600">'+(l.size||'-')+'"</td><td>'+catLabel+'</td><td>'+statusBadge+'</td></tr>';
    });
    html+='</tbody></table></div></details>';
    return html;
}

function extractOrderId(text,items){
    for(var i=0;i<items.length;i++){
        if(/Order\s*No/i.test(items[i])){
            for(var j=i+1;j<Math.min(i+15,items.length);j++){
                var val=items[j].trim();
                if(/^\d{10,}(?:_\d+)?$/.test(val))return val;
            }
        }
    }
    var m=text.match(/(\d{10,}_\d+)/);
    if(m)return m[1];
    m=text.match(/Sub\s*Order\s*(?:No\.?|Number|ID)?\s*[:\-]?\s*([A-Za-z0-9\-_]{8,})/i);
    if(m)return m[1].trim();
    m=text.match(/(?:^|\s)(\d{10,})(?:\s|$)/);
    if(m)return m[1].trim();
    return null;
}

function extractSku(text,items){
    var skuIdx=-1;
    for(var i=0;i<items.length;i++){if(/^SKU$/i.test(items[i].trim())){skuIdx=i;break;}}
    if(skuIdx===-1)return null;
    var lastHeaderIdx=skuIdx;
    for(var i=skuIdx+1;i<Math.min(skuIdx+10,items.length);i++){
        var t=items[i].trim();
        if(/^(Size|Qty|Quantity|Color|Colour|Order\s*No\.?)$/i.test(t))lastHeaderIdx=i;
    }
    var skuParts=[];
    for(var j=lastHeaderIdx+1;j<Math.min(lastHeaderIdx+12,items.length);j++){
        var val=items[j].trim();
        if(!val)continue;
        if(/^\d+\.\d+$/.test(val))break;
        if(/^\d{1,3}$/.test(val)&&skuParts.length>0)break;
        if(/^(Multicolor|Multi|TAX|Original)/i.test(val))break;
        if(/^\d{10,}/.test(val))break;
        skuParts.push(val);
    }
    if(skuParts.length>0)return skuParts.join(' ').replace(/\s+/g,' ').trim();
    for(var j=skuIdx+1;j<Math.min(skuIdx+5,items.length);j++){
        var val=items[j].trim();
        if(val.length>=2&&!/^(Size|Qty|Color|Order|Quantity|No\.?)$/i.test(val))return val;
    }
    return null;
}

function extractSize(text,items){
    // Find "Size" header, then look for value like 2.2, 2.4 etc after data row starts
    var sizeIdx=-1;
    for(var i=0;i<items.length;i++){if(/^Size$/i.test(items[i].trim())){sizeIdx=i;break;}}
    if(sizeIdx===-1){
        // Fallback: find pattern like 2.0-2.12 in text
        var m=text.match(/\b(2\.\d{1,2})\b/);
        return m?m[1]:null;
    }
    // Find "Order No." header to know where headers end
    var lastHeaderIdx=sizeIdx;
    for(var i=sizeIdx+1;i<Math.min(sizeIdx+8,items.length);i++){
        var t=items[i].trim();
        if(/^(Qty|Quantity|Color|Colour|Order\s*No\.?)$/i.test(t))lastHeaderIdx=i;
    }
    // Scan after headers for size value (decimal number like 2.2)
    for(var j=lastHeaderIdx+1;j<Math.min(lastHeaderIdx+15,items.length);j++){
        var val=items[j].trim();
        if(/^\d+\.\d{1,2}$/.test(val)&&parseFloat(val)>=1.5&&parseFloat(val)<=3.5)return val;
    }
    return null;
}

// STOCK
function populateItemDropdown(){var s=document.getElementById('o-item');s.innerHTML='<option value="">-- Select --</option>'+stockData.map(function(i){return'<option value="'+i.id+'" data-size="'+i.size+'" data-price="'+i.price+'">'+i.name+' ('+i.size+'") ‚Çπ'+i.price+'</option>';}).join('');}
function getStockOptions(sel){return'<option value="">--</option>'+stockData.map(function(s){return'<option value="'+s.name+'"'+(sel===s.name?' selected':'')+'>'+s.name+'</option>';}).join('');}
document.addEventListener('change',function(e){if(e.target.id==='o-item'){var opt=e.target.options[e.target.selectedIndex];if(opt.value){document.getElementById('o-size').value=opt.dataset.size;document.getElementById('o-amt').value=opt.dataset.price;}}});

// TABS
document.querySelectorAll('.tab-btn').forEach(function(btn){btn.addEventListener('click',function(){document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active');});document.querySelectorAll('.tab-content').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');document.getElementById('tab-'+btn.dataset.tab).classList.add('active');});});
document.querySelectorAll('.plat-btn').forEach(function(btn){btn.addEventListener('click',function(){document.querySelectorAll('.plat-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');platform=btn.dataset.p;});});
document.querySelectorAll('[data-f],[data-s]').forEach(function(btn){btn.addEventListener('click',function(){if(btn.dataset.f){document.querySelectorAll('.filter-btn[data-f]').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');filterPlat=btn.dataset.f;}if(btn.dataset.s){if(btn.classList.contains('active')){btn.classList.remove('active');filterStatus='all';}else{document.querySelectorAll('.filter-btn[data-s]').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');filterStatus=btn.dataset.s;}}renderOrders();});});

// STOCK CRUD
document.getElementById('addStockBtn').addEventListener('click',async function(){
    var name=document.getElementById('s-name').value.trim(),qty=document.getElementById('s-qty').value,cost=document.getElementById('s-cost').value,price=document.getElementById('s-price').value;
    if(!name||!qty||!cost||!price){alert('Fill all fields');return;}
    setStatus('üîÑ Adding...','syncing');
    try{await db.from('stock').insert({name,size:document.getElementById('s-size').value,qty:parseInt(qty),cost:parseFloat(cost),price:parseFloat(price)});document.getElementById('s-name').value='';document.getElementById('s-qty').value='';document.getElementById('s-cost').value='';document.getElementById('s-price').value='';await loadStock();setStatus('‚úÖ Added!');}catch(err){setStatus('‚ùå '+err.message,'error');}
});
window.delStock=async function(id){if(!confirm('Delete?'))return;try{await db.from('stock').delete().eq('id',id);await loadStock();setStatus('‚úÖ Deleted');}catch(err){setStatus('‚ùå '+err.message,'error');}};
window.editStock=function(id){var item=stockData.find(function(x){return x.id===id;});if(!item)return;document.getElementById('edit-id').value=id;document.getElementById('edit-name').value=item.name;document.getElementById('edit-size').value=item.size;document.getElementById('edit-qty').value=item.qty;document.getElementById('edit-cost').value=item.cost;document.getElementById('edit-price').value=item.price;document.getElementById('editModal').classList.add('show');};
window.saveEdit=async function(){var id=parseInt(document.getElementById('edit-id').value);try{await db.from('stock').update({name:document.getElementById('edit-name').value,size:document.getElementById('edit-size').value,qty:parseInt(document.getElementById('edit-qty').value),cost:parseFloat(document.getElementById('edit-cost').value),price:parseFloat(document.getElementById('edit-price').value)}).eq('id',id);closeModal();await loadStock();setStatus('‚úÖ Updated');}catch(err){setStatus('‚ùå '+err.message,'error');}};
window.updateQty=async function(id,val){try{await db.from('stock').update({qty:parseInt(val)||0}).eq('id',id);await loadStock();}catch(err){setStatus('‚ùå '+err.message,'error');}};

// ORDERS CRUD
document.getElementById('addOrderBtn').addEventListener('click',async function(){
    var orderId=document.getElementById('o-id').value.trim(),itemId=document.getElementById('o-item').value,qty=parseInt(document.getElementById('o-qty').value)||1,amt=document.getElementById('o-amt').value;
    if(!orderId||!itemId||!amt){alert('Fill required fields');return;}
    var si=stockData.find(function(x){return x.id===parseInt(itemId);});if(!si)return;
    if(si.qty<qty){alert('Not enough stock: '+si.qty);return;}
    setStatus('üîÑ Adding...','syncing');
    try{
        await db.from('orders').insert({order_id:orderId,customer:document.getElementById('o-cust').value.trim()||null,state:document.getElementById('o-state').value.trim()||null,items:si.name,size:document.getElementById('o-size').value,qty,amount:parseFloat(amt)*qty,received:parseFloat(document.getElementById('o-recv').value)||0,platform,status:document.getElementById('o-status').value,remark:si.name,order_date:document.getElementById('o-date').value||new Date().toISOString().split('T')[0]});
        await db.from('stock').update({qty:si.qty-qty}).eq('id',si.id);
        document.getElementById('o-id').value='';document.getElementById('o-cust').value='';document.getElementById('o-state').value='';document.getElementById('o-item').value='';document.getElementById('o-qty').value='1';document.getElementById('o-amt').value='';document.getElementById('o-recv').value='0';
        await loadStock();await loadOrders();setStatus('‚úÖ Order added!');
    }catch(err){setStatus('‚ùå '+err.message,'error');}
});
window.delOrder=async function(id){if(!confirm('Delete?'))return;try{await db.from('orders').delete().eq('id',id);await loadOrders();setStatus('‚úÖ Deleted');}catch(err){setStatus('‚ùå '+err.message,'error');}};
window.updateRemark=async function(id,val){try{await db.from('orders').update({remark:val||null}).eq('id',id);setStatus('‚úÖ Saved');}catch(err){setStatus('‚ùå '+err.message,'error');}};
window.closeModal=function(){document.querySelectorAll('.modal-bg').forEach(function(m){m.classList.remove('show');});};

// FILE UPLOAD
window.handleFileUpload=async function(input){
    var file=input.files[0];if(!file)return;var statusDiv=document.getElementById('importStatus');
    statusDiv.innerHTML='<div class="alert alert-success">üìä Reading file...</div>';setStatus('üîÑ Importing...','syncing');
    var isCSV=file.name.toLowerCase().endsWith('.csv');var reader=new FileReader();
    reader.onload=async function(e){
        try{var rows=[];
            if(isCSV){var text=e.target.result;var lines=text.split('\n');for(var i=0;i<lines.length;i++){var row=[];var line=lines[i];var inQ=false,val='';for(var j=0;j<line.length;j++){var c=line[j];if(c==='"'){inQ=!inQ;}else if(c===','&&!inQ){row.push(val.trim());val='';}else{val+=c;}}row.push(val.trim());if(row.length>1)rows.push(row);}}
            else{var data=new Uint8Array(e.target.result);var wb=XLSX.read(data,{type:'array'});var sn=wb.SheetNames.find(function(n){return n.includes('Order');})||wb.SheetNames[1]||wb.SheetNames[0];rows=XLSX.utils.sheet_to_json(wb.Sheets[sn],{header:1});}
            var hRow=-1;for(var i=0;i<Math.min(10,rows.length);i++){var row=rows[i];if(row&&row.some(function(c){return c&&(c.toString().includes('Sub Order')||c.toString().includes('Order No'));})){hRow=i;break;}}
            if(hRow===-1){statusDiv.innerHTML='<div class="alert alert-danger">‚ùå No order data found</div>';return;}
            var headers=rows[hRow];var cm={};
            headers.forEach(function(h,idx){if(!h)return;var hl=h.toString().toLowerCase();
                if(hl.includes('sub order')||hl.includes('order no'))cm.orderId=idx;
                if(hl.includes('order date')&&cm.date===undefined)cm.date=idx;
                if(hl.includes('product name'))cm.product=idx;
                if(hl.includes('sku'))cm.sku=idx;
                if(hl==='size'||hl.includes('size'))cm.size=idx;
                if(hl.includes('quantity'))cm.qty=idx;
                if(hl.includes('customer state')||hl==='state')cm.state=idx;
                if(hl.includes('reason')||hl.includes('status')||hl.includes('live order'))cm.status=idx;
                if(hl.includes('final settlement'))cm.received=idx;
                if((hl.includes('supplier')&&hl.includes('price'))||(hl.includes('total sale')&&!hl.includes('return')))cm.amount=idx;
            });
            var imp=0,skip=0,upd=0;
            for(var r=hRow+1;r<rows.length;r++){
                var row=rows[r];if(!row||!row[cm.orderId])continue;var oid=row[cm.orderId].toString().trim();if(oid.length<5)continue;
                var existing=ordersData.find(function(o){return o.order_id===oid;});
                var status=row[cm.status]?row[cm.status].toString():'Pending';
                if(status.toLowerCase().includes('deliver'))status='Delivered';else if(status.toLowerCase().includes('rto')||status.toLowerCase().includes('return'))status='RTO';else status='Pending';
                var od='';if(row[cm.date]){var d=row[cm.date];if(typeof d==='number'){od=new Date((d-25569)*86400*1000).toISOString().split('T')[0];}else{od=d.toString().split(' ')[0].split('T')[0];}}
                var sku=row[cm.sku]?row[cm.sku].toString().trim():'';var size=row[cm.size]?row[cm.size].toString().trim():'';var state=row[cm.state]?row[cm.state].toString().trim():'';
                if(existing){try{await db.from('orders').update({status:status,size:size||existing.size,state:state||existing.state,remark:sku||existing.remark}).eq('id',existing.id);upd++;}catch(err){}}
                else{try{await db.from('orders').insert({order_id:oid,items:row[cm.product]?row[cm.product].toString().substring(0,200):'',size:size,qty:parseInt(row[cm.qty])||1,state:state,amount:parseFloat(row[cm.amount])||0,received:parseFloat(row[cm.received])||0,status:status,platform:'meesho',remark:sku,order_date:od||new Date().toISOString().split('T')[0]});imp++;}catch(err){skip++;}}
            }
            await loadOrders();statusDiv.innerHTML='<div class="alert alert-success">‚úÖ New: <b>'+imp+'</b> | Updated: <b>'+upd+'</b> | Skipped: <b>'+skip+'</b></div>';setStatus('‚úÖ Import done!');input.value='';
        }catch(err){statusDiv.innerHTML='<div class="alert alert-danger">‚ùå '+err.message+'</div>';setStatus('‚ùå Failed','error');}
    };
    if(isCSV){reader.readAsText(file);}else{reader.readAsArrayBuffer(file);}
};

// EXPORT
window.exportData=function(){
    var csv='Type,Name,SKU,Size,Qty,State,Status,Amount,Received\n';
    stockData.forEach(function(s){csv+='Stock,"'+s.name+'",,'+s.size+','+s.qty+',,,'+s.cost+','+s.price+'\n';});
    ordersData.forEach(function(o){csv+='Order,"'+o.order_id+'","'+(o.remark||'')+'",'+(o.size||'')+','+(o.qty||1)+','+(o.state||'')+','+(o.status||'')+','+o.amount+','+o.received+'\n';});
    var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download='glass-hut-'+new Date().toISOString().split('T')[0]+'.csv';a.click();
};

// RENDERERS
function renderDashboard(){
    var sv=stockData.reduce(function(s,x){return s+(x.qty*x.cost);},0);
    var sales=ordersData.reduce(function(s,x){return s+x.amount;},0);
    var recv=ordersData.reduce(function(s,x){return s+x.received;},0);
    var del=ordersData.filter(function(x){return x.status==='Delivered';}).length;
    var rto=ordersData.filter(function(x){return x.status==='RTO';}).length;
    var low=stockData.filter(function(x){return x.qty<=20;});
    document.getElementById('d-stock').textContent='‚Çπ'+sv.toLocaleString();
    document.getElementById('d-sales').textContent='‚Çπ'+sales.toLocaleString();
    document.getElementById('d-recv').textContent='‚Çπ'+recv.toLocaleString();
    document.getElementById('d-del').textContent=del;document.getElementById('d-rto').textContent=rto;
    document.getElementById('alertBox').innerHTML=low.length>0?'<div class="alert alert-danger">‚ö†Ô∏è Low: '+low.map(function(x){return x.name+'('+x.qty+')';}).join(', ')+'</div>':'';
    document.getElementById('dashLow').innerHTML=low.length>0?low.slice(0,5).map(function(x){return'<div style="display:flex;justify-content:space-between;padding:0.25rem 0;border-bottom:1px solid #fef3c7;font-size:0.75rem"><span>'+x.name+'</span><span style="color:#dc2626">'+x.qty+'</span></div>';}).join(''):'<div class="empty">All OK ‚úÖ</div>';
    document.getElementById('dashRecent').innerHTML=ordersData.length>0?ordersData.slice(0,5).map(function(x){return'<div style="display:flex;justify-content:space-between;padding:0.25rem 0;border-bottom:1px solid #fef3c7;font-size:0.7rem"><span>'+(x.remark||x.order_id.substring(0,10)+'..')+' <span class="badge badge-'+(x.status||'pending').toLowerCase()+'">'+(x.status||'?')+'</span></span><span>‚Çπ'+x.amount+'</span></div>';}).join(''):'<div class="empty">No orders</div>';
}
function renderStock(){
    document.getElementById('stockCnt').textContent=stockData.length;
    document.getElementById('stockTbl').innerHTML=stockData.length>0?stockData.map(function(x){var isLow=x.qty<=20;return'<tr class="'+(isLow?'low-stock':'')+'"><td><b>'+x.name+'</b></td><td>'+x.size+'"</td><td><input type="number" class="qty-input" value="'+x.qty+'" onchange="updateQty('+x.id+',this.value)" min="0" style="'+(isLow?'color:#dc2626;font-weight:600':'')+'"></td><td>‚Çπ'+x.cost+'</td><td style="color:#059669">‚Çπ'+x.price+'</td><td style="font-weight:600">‚Çπ'+(x.qty*x.cost).toLocaleString()+'</td><td><button class="act-btn edit" onclick="editStock('+x.id+')">‚úèÔ∏è</button><button class="act-btn del" onclick="delStock('+x.id+')">üóëÔ∏è</button></td></tr>';}).join(''):'<tr><td colspan="7" class="empty">No stock</td></tr>';
}
function renderOrders(){
    var filtered=ordersData;
    if(filterPlat!=='all')filtered=filtered.filter(function(x){return x.platform===filterPlat;});
    if(filterStatus!=='all')filtered=filtered.filter(function(x){return x.status===filterStatus;});
    document.getElementById('ordCnt').textContent=filtered.length;
    document.getElementById('ordTbl').innerHTML=filtered.length>0?filtered.map(function(x){
        var sp=x.items?(x.items.length>18?x.items.substring(0,18)+'..':x.items):'-';
        return'<tr><td style="font-size:0.55rem;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+x.order_id+'">'+x.order_id+'</td><td class="product-cell"><span class="product-short" title="'+(x.items||'')+'">'+sp+'</span></td><td><select class="remark-select" onchange="updateRemark('+x.id+',this.value)">'+getStockOptions(x.remark)+'</select></td><td>'+(x.size||'-')+'"</td><td>'+(x.qty||1)+'</td><td style="font-size:0.55rem">'+(x.state||'-')+'</td><td><span class="badge badge-'+x.platform+'">'+x.platform+'</span></td><td><span class="badge badge-'+(x.status||'pending').toLowerCase()+'">'+(x.status||'?')+'</span></td><td style="font-size:0.55rem">'+x.order_date+'</td><td style="font-weight:600">‚Çπ'+x.amount.toLocaleString()+'</td><td style="color:#059669">‚Çπ'+x.received.toLocaleString()+'</td><td><button class="act-btn del" onclick="delOrder('+x.id+')">üóëÔ∏è</button></td></tr>';
    }).join(''):'<tr><td colspan="12" class="empty">No orders</td></tr>';
}

// UTILS
function escapeHtml(str){var d=document.createElement('div');d.textContent=str;return d.innerHTML;}
function normSku(s){return(s||'').toLowerCase().replace(/\s+/g,' ').trim();}

// Find category: exact match only, else Uncategorized
function findCategory(sku){
    var exact=skuData.find(function(s){return normSku(s.sku_name)===normSku(sku);});
    if(exact)return{category:exact.category};
    return null;
}
function escapeJs(str){return str.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"');}
function escapeAttr(str){return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// INIT
document.addEventListener('DOMContentLoaded',function(){checkAuth();});
document.getElementById('loginPassword').addEventListener('keypress',function(e){if(e.key==='Enter')doLogin();});
document.getElementById('loginEmail').addEventListener('keypress',function(e){if(e.key==='Enter')document.getElementById('loginPassword').focus();});
document.querySelectorAll('.upload-box').forEach(function(box){
    box.addEventListener('dragover',function(e){e.preventDefault();box.style.borderColor='#f59e0b';});
    box.addEventListener('dragleave',function(e){e.preventDefault();box.style.borderColor='#fcd34d';});
    box.addEventListener('drop',function(e){e.preventDefault();box.style.borderColor='#fcd34d';if(e.dataTransfer.files.length>0){var inp=box.querySelector('input[type="file"]');if(inp){inp.files=e.dataTransfer.files;inp.dispatchEvent(new Event('change'));}}});
});
</script>
</body>
</html>

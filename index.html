<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass HUT - Stock & Sales Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); min-height: 100vh; }
        
        .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .login-box { background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-width: 400px; width: 100%; overflow: hidden; }
        .login-header { background: linear-gradient(135deg, #d97706, #ea580c); color: white; padding: 2rem; text-align: center; }
        .login-header h1 { font-size: 1.8rem; margin-bottom: 0.25rem; }
        .login-header p { opacity: 0.9; font-size: 0.85rem; }
        .login-body { padding: 2rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.8rem; color: #6b7280; margin-bottom: 0.3rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid #fde68a; border-radius: 10px; font-family: inherit; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { border-color: #f59e0b; outline: none; }
        .login-btn { width: 100%; padding: 0.9rem; border: none; border-radius: 10px; background: linear-gradient(135deg, #d97706, #ea580c); color: white; font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 0.5rem; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(217, 119, 6, 0.4); }
        .login-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .login-error { background: #fee2e2; color: #991b1b; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; display: none; }
        
        .app-container { display: none; }
        .app-container.show { display: block; }
        .login-page.hide { display: none; }
        
        .header { background: linear-gradient(135deg, #d97706, #ea580c); color: white; padding: 1rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .logo { display: flex; align-items: center; gap: 0.5rem; }
        .logo h1 { font-size: 1.3rem; }
        .logo p { font-size: 0.7rem; opacity: 0.9; }
        .user-info { font-size: 0.8rem; opacity: 0.9; }
        
        .header-btns { display: flex; gap: 0.4rem; flex-wrap: wrap; }
        .btn { padding: 0.5rem 0.9rem; border: none; border-radius: 8px; font-family: inherit; font-weight: 500; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .btn-light { background: rgba(255,255,255,0.2); color: white; }
        .btn-light:hover { background: rgba(255,255,255,0.3); }
        .btn-primary { background: linear-gradient(135deg, #f59e0b, #ea580c); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-outline { background: white; border: 2px solid #fcd34d; color: #92400e; }
        
        .tabs { background: white; border-bottom: 2px solid #fde68a; position: sticky; top: 60px; z-index: 90; }
        .tabs-content { max-width: 1400px; margin: 0 auto; display: flex; }
        .tab-btn { flex: 1; padding: 1rem; border: none; background: transparent; font-family: inherit; font-weight: 600; cursor: pointer; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab-btn:hover { background: #fffbeb; }
        .tab-btn.active { color: #d97706; border-bottom-color: #d97706; background: #fffbeb; }
        
        .main { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .sum-card { background: white; border-radius: 12px; padding: 0.8rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .sum-card .label { font-size: 0.65rem; color: #6b7280; }
        .sum-card .value { font-size: 1.2rem; font-weight: 700; color: #d97706; }
        .sum-card.green .value { color: #059669; }
        .sum-card.blue .value { color: #2563eb; }
        .sum-card.red .value { color: #dc2626; }
        
        .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 15px rgba(0,0,0,0.08); margin-bottom: 1rem; }
        .card-header { background: #fef3c7; padding: 1rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-body { padding: 1rem; }
        
        .form-box { background: #fffbeb; border: 2px dashed #fcd34d; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .form-box h4 { font-size: 0.95rem; color: #92400e; margin-bottom: 1rem; }
        .form-row { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 0.75rem; }
        .form-grp { flex: 1; min-width: 120px; }
        .form-grp label { display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem; }
        .form-grp input, .form-grp select { width: 100%; padding: 0.6rem; border: 2px solid #fde68a; border-radius: 8px; font-family: inherit; font-size: 0.9rem; }
        .form-grp input:focus, .form-grp select:focus { border-color: #f59e0b; outline: none; }
        
        .platform-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .plat-btn { padding: 0.4rem 0.8rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .plat-btn:hover { border-color: #fcd34d; }
        .plat-btn.active { border-color: #f59e0b; background: #fef3c7; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        th, td { padding: 0.4rem 0.3rem; text-align: left; border-bottom: 1px solid #fef3c7; }
        th { background: #fef3c7; font-weight: 600; color: #92400e; font-size: 0.65rem; position: sticky; top: 0; }
        tr:hover { background: #fffbeb; }
        .low-stock { background: #fee2e2 !important; }
        
        .badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 10px; font-size: 0.55rem; font-weight: 500; }
        .badge-meesho { background: #fdf2f8; color: #be185d; }
        .badge-amazon { background: #fff7ed; color: #c2410c; }
        .badge-flipkart { background: #eff6ff; color: #1d4ed8; }
        .badge-other { background: #f3f4f6; color: #374151; }
        .badge-delivered { background: #d1fae5; color: #065f46; }
        .badge-rto { background: #fee2e2; color: #991b1b; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        
        .act-btn { padding: 0.2rem 0.35rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.65rem; margin: 0 1px; transition: all 0.2s; }
        .act-btn:hover { transform: scale(1.1); }
        .act-btn.edit { background: #dbeafe; color: #1e40af; }
        .act-btn.del { background: #fee2e2; color: #991b1b; }
        
        .qty-input { width: 50px; padding: 0.2rem; border: 1px solid #fcd34d; border-radius: 4px; text-align: center; font-size: 0.7rem; }
        .remark-select { width: 90px; padding: 0.15rem; border: 1px solid #fcd34d; border-radius: 4px; font-size: 0.6rem; background: white; }
        
        .filters { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: center; }
        .filter-btn { padding: 0.3rem 0.6rem; border: 2px solid #fde68a; border-radius: 15px; background: white; cursor: pointer; font-size: 0.65rem; transition: all 0.2s; }
        .filter-btn:hover { border-color: #f59e0b; }
        .filter-btn.active { background: #f59e0b; color: white; border-color: #f59e0b; }
        
        .empty { text-align: center; padding: 2rem; color: #9ca3af; }
        .loading { text-align: center; padding: 2rem; color: #f59e0b; }
        
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 1rem; }
        .modal-bg.show { display: flex; }
        .modal { background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-head { padding: 1rem; background: #fef3c7; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .modal-head h3 { font-size: 1rem; color: #92400e; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 1rem; }
        
        .upload-box { border: 3px dashed #fcd34d; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .upload-box:hover { border-color: #f59e0b; background: #fffbeb; }
        .upload-box input { display: none; }
        .upload-box p { color: #6b7280; margin-top: 0.5rem; font-size: 0.8rem; }
        
        .alert { padding: 0.75rem; border-radius: 10px; margin-bottom: 1rem; font-size: 0.8rem; }
        .alert-danger { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; }
        .alert-success { background: #d1fae5; border: 1px solid #6ee7b7; color: #065f46; }
        
        .status-bar { background: #065f46; color: white; padding: 0.5rem 1rem; font-size: 0.75rem; text-align: center; }
        .status-bar.error { background: #991b1b; }
        .status-bar.syncing { background: #2563eb; }
        
        .product-cell { max-width: 150px; }
        .product-short { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: help; }
        
        @media (max-width: 768px) {
            .form-row { flex-direction: column; }
            .form-grp { min-width: 100%; }
            .summary { grid-template-columns: 1fr 1fr; }
            th, td { padding: 0.25rem 0.15rem; font-size: 0.6rem; }
            .header h1 { font-size: 1rem; }
            .product-cell { max-width: 70px; }
            .remark-select { width: 65px; }
        }
    </style>
</head>
<body>
    <div class="login-page" id="loginPage">
        <div class="login-box">
            <div class="login-header">
                <div style="font-size:3rem;margin-bottom:0.5rem">üíé</div>
                <h1>Glass HUT</h1>
                <p>Stock & Sales Manager</p>
            </div>
            <div class="login-body">
                <div class="login-error" id="loginError"></div>
                <div class="form-group"><label>Email</label><input type="email" id="loginEmail" placeholder="your@email.com"></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button class="login-btn" id="loginBtn" onclick="doLogin()">Login</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="status-bar" id="statusBar">üîÑ Connecting...</div>
        
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span style="font-size:1.5rem">üíé</span>
                    <div><h1>Glass HUT</h1><p>Stock & Sales Manager</p></div>
                </div>
                <div class="header-btns">
                    <span class="user-info" id="userEmail"></span>
                    <button class="btn btn-light" onclick="exportData()">üì• Export</button>
                    <button class="btn btn-light" onclick="refreshData()">üîÑ</button>
                    <button class="btn btn-light" onclick="doLogout()">üö™</button>
                </div>
            </div>
        </header>
        
        <nav class="tabs">
            <div class="tabs-content">
                <button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
                <button class="tab-btn" data-tab="stock">üì¶ Stock</button>
                <button class="tab-btn" data-tab="orders">üõí Orders</button>
            </div>
        </nav>
        
        <main class="main">
            <div class="tab-content active" id="tab-dashboard">
                <div class="summary">
                    <div class="sum-card"><div class="label">Stock Value</div><div class="value" id="d-stock">‚Çπ0</div></div>
                    <div class="sum-card"><div class="label">Total Sales</div><div class="value" id="d-sales">‚Çπ0</div></div>
                    <div class="sum-card green"><div class="label">Received</div><div class="value" id="d-recv">‚Çπ0</div></div>
                    <div class="sum-card blue"><div class="label">Delivered</div><div class="value" id="d-del">0</div></div>
                    <div class="sum-card red"><div class="label">RTO</div><div class="value" id="d-rto">0</div></div>
                </div>
                <div id="alertBox"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                    <div class="card"><div class="card-header">üì¶ Low Stock</div><div class="card-body" id="dashLow"><div class="loading">Loading...</div></div></div>
                    <div class="card"><div class="card-header">üïê Recent Orders</div><div class="card-body" id="dashRecent"><div class="loading">Loading...</div></div></div>
                </div>
            </div>
            
            <div class="tab-content" id="tab-stock">
                <div class="form-box">
                    <h4>‚ûï Add Stock Item</h4>
                    <div class="form-row">
                        <div class="form-grp"><label>Product Name *</label><input type="text" id="s-name" placeholder="Glass Bangles"></div>
                        <div class="form-grp" style="max-width:100px"><label>Size *</label>
                            <select id="s-size"><option>2.0</option><option>2.1</option><option>2.2</option><option>2.3</option><option selected>2.4</option><option>2.5</option><option>2.6</option><option>2.7</option><option>2.8</option><option>2.9</option><option>2.10</option><option>2.11</option><option>2.12</option></select>
                        </div>
                        <div class="form-grp"><label>Quantity *</label><input type="number" id="s-qty" min="0" placeholder="100"></div>
                        <div class="form-grp"><label>Cost ‚Çπ *</label><input type="number" id="s-cost" min="0" step="0.01" placeholder="50"></div>
                        <div class="form-grp"><label>Price ‚Çπ *</label><input type="number" id="s-price" min="0" step="0.01" placeholder="100"></div>
                    </div>
                    <div style="text-align:right;margin-top:0.5rem"><button class="btn btn-primary" id="addStockBtn">‚ûï Add</button></div>
                </div>
                <div class="card">
                    <div class="card-header"><span>üì¶ Stock (<span id="stockCnt">0</span>)</span></div>
                    <div style="overflow-x:auto"><table>
                        <thead><tr><th>Product</th><th>Size</th><th>Qty</th><th>Cost</th><th>Price</th><th>Value</th><th>Act</th></tr></thead>
                        <tbody id="stockTbl"><tr><td colspan="7" class="loading">Loading...</td></tr></tbody>
                    </table></div>
                </div>
            </div>
            
            <div class="tab-content" id="tab-orders">
                <div class="form-box">
                    <h4>üìä Import Meesho File (Excel or CSV)</h4>
                    <div class="upload-box" onclick="document.getElementById('excelFile').click()">
                        <div style="font-size:2rem">üìÅ</div>
                        <p><strong>Click to upload</strong><br>Excel (.xlsx) or CSV (.csv)</p>
                        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(this)">
                    </div>
                    <div id="importStatus" style="margin-top:0.75rem"></div>
                </div>
                
                <div class="form-box">
                    <h4>‚ûï Add Order Manually</h4>
                    <div class="form-row">
                        <div class="form-grp"><label>Order ID *</label><input type="text" id="o-id" placeholder="MS12345"></div>
                        <div class="form-grp"><label>Customer</label><input type="text" id="o-cust" placeholder="Name"></div>
                        <div class="form-grp"><label>State</label><input type="text" id="o-state" placeholder="Delhi"></div>
                        <div class="form-grp"><label>Date</label><input type="date" id="o-date"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-grp" style="flex:2"><label>Item *</label><select id="o-item"><option value="">-- Select --</option></select></div>
                        <div class="form-grp" style="max-width:80px"><label>Size *</label>
                            <select id="o-size"><option>2.0</option><option>2.1</option><option>2.2</option><option>2.3</option><option selected>2.4</option><option>2.5</option><option>2.6</option><option>2.7</option><option>2.8</option><option>2.9</option><option>2.10</option><option>2.11</option><option>2.12</option></select>
                        </div>
                        <div class="form-grp" style="max-width:60px"><label>Qty *</label><input type="number" id="o-qty" min="1" value="1"></div>
                        <div class="form-grp"><label>Amount ‚Çπ *</label><input type="number" id="o-amt" min="0"></div>
                        <div class="form-grp"><label>Received ‚Çπ</label><input type="number" id="o-recv" value="0" min="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-grp" style="max-width:120px"><label>Status</label>
                            <select id="o-status"><option value="Pending">Pending</option><option value="Delivered">Delivered</option><option value="RTO">RTO</option></select>
                        </div>
                        <div class="form-grp"><label>Platform</label>
                            <div class="platform-btns" style="margin-top:0.25rem">
                                <span class="plat-btn active" data-p="meesho">üõçÔ∏è Meesho</span>
                                <span class="plat-btn" data-p="amazon">üì¶ Amazon</span>
                                <span class="plat-btn" data-p="flipkart">üõí Flipkart</span>
                                <span class="plat-btn" data-p="other">üì± Other</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:right;margin-top:0.5rem"><button class="btn btn-primary" id="addOrderBtn">‚ûï Add</button></div>
                </div>
                
                <div class="filters">
                    <span style="font-size:0.65rem;color:#6b7280">Platform:</span>
                    <button class="filter-btn active" data-f="all">All</button>
                    <button class="filter-btn" data-f="meesho">Meesho</button>
                    <button class="filter-btn" data-f="amazon">Amazon</button>
                    <button class="filter-btn" data-f="flipkart">Flipkart</button>
                    <span style="margin-left:0.5rem;font-size:0.65rem;color:#6b7280">Status:</span>
                    <button class="filter-btn" data-s="Delivered">‚úÖ</button>
                    <button class="filter-btn" data-s="RTO">üîÑ</button>
                    <button class="filter-btn" data-s="Pending">‚è≥</button>
                </div>
                
                <div class="card">
                    <div class="card-header"><span>üõí Orders (<span id="ordCnt">0</span>)</span></div>
                    <div style="overflow-x:auto;max-height:450px"><table>
                        <thead><tr><th>Order ID</th><th>Product</th><th>SKU/Stock</th><th>Size</th><th>Qty</th><th>State</th><th>Platform</th><th>Status</th><th>Date</th><th>Amount</th><th>Received</th><th>X</th></tr></thead>
                        <tbody id="ordTbl"><tr><td colspan="12" class="loading">Loading...</td></tr></tbody>
                    </table></div>
                </div>
            </div>
        </main>
    </div>
    
    <div class="modal-bg" id="editModal">
        <div class="modal">
            <div class="modal-head"><h3>‚úèÔ∏è Edit Stock</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div class="form-group"><label>Product Name</label><input type="text" id="edit-name"></div>
                <div class="form-row">
                    <div class="form-grp"><label>Size</label><select id="edit-size"><option>2.0</option><option>2.1</option><option>2.2</option><option>2.3</option><option>2.4</option><option>2.5</option><option>2.6</option><option>2.7</option><option>2.8</option><option>2.9</option><option>2.10</option><option>2.11</option><option>2.12</option></select></div>
                    <div class="form-grp"><label>Quantity</label><input type="number" id="edit-qty" min="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-grp"><label>Cost ‚Çπ</label><input type="number" id="edit-cost" min="0" step="0.01"></div>
                    <div class="form-grp"><label>Price ‚Çπ</label><input type="number" id="edit-price" min="0" step="0.01"></div>
                </div>
                <div style="display:flex;gap:0.5rem;margin-top:1rem">
                    <button class="btn btn-outline" onclick="closeModal()" style="flex:1">Cancel</button>
                    <button class="btn btn-success" onclick="saveEdit()" style="flex:1">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const SUPABASE_URL = 'https://fjogabazmjrzulkpihyy.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqb2dhYmF6bWpyenVsa3BpaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjQ4MDksImV4cCI6MjA4NDQwMDgwOX0.-OmFa7Hog-zBwpSE_9cjfxnBXbCjpawAtKtY-E1Ez2w';
    const { createClient } = window.supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let stockData = [], ordersData = [], platform = 'meesho', filterPlat = 'all', filterStatus = 'all', currentUser = null;
    
    function showError(msg) { var el = document.getElementById('loginError'); el.textContent = msg; el.style.display = 'block'; }
    
    async function doLogin() {
        var email = document.getElementById('loginEmail').value.trim(), password = document.getElementById('loginPassword').value;
        if (!email || !password) { showError('Enter email and password'); return; }
        document.getElementById('loginBtn').disabled = true; document.getElementById('loginBtn').textContent = 'Logging in...';
        document.getElementById('loginError').style.display = 'none';
        try {
            var result = await db.auth.signInWithPassword({ email, password });
            if (result.error) throw new Error(result.error.message);
            currentUser = result.data.user; showApp();
        } catch (err) { showError(err.message); }
        document.getElementById('loginBtn').disabled = false; document.getElementById('loginBtn').textContent = 'Login';
    }
    
    async function doLogout() { await db.auth.signOut(); currentUser = null; document.getElementById('loginPage').classList.remove('hide'); document.getElementById('appContainer').classList.remove('show'); }
    function showApp() { document.getElementById('loginPage').classList.add('hide'); document.getElementById('appContainer').classList.add('show'); document.getElementById('userEmail').textContent = 'üë§ ' + currentUser.email; document.getElementById('o-date').value = new Date().toISOString().split('T')[0]; refreshData(); }
    async function checkAuth() { var result = await db.auth.getSession(); if (result.data.session) { currentUser = result.data.session.user; showApp(); } }
    function setStatus(msg, type) { var bar = document.getElementById('statusBar'); bar.textContent = msg; bar.className = 'status-bar' + (type === 'error' ? ' error' : type === 'syncing' ? ' syncing' : ''); }
    
    async function loadStock() {
        try { var result = await db.from('stock').select('*').order('created_at', { ascending: false }); if (result.error) throw new Error(result.error.message); stockData = result.data || []; renderStock(); renderDashboard(); populateItemDropdown(); return true; }
        catch (err) { setStatus('‚ùå ' + err.message, 'error'); return false; }
    }
    async function loadOrders() {
        try { var result = await db.from('orders').select('*').order('created_at', { ascending: false }); if (result.error) throw new Error(result.error.message); ordersData = result.data || []; renderOrders(); renderDashboard(); return true; }
        catch (err) { setStatus('‚ùå ' + err.message, 'error'); return false; }
    }
    async function refreshData() { setStatus('üîÑ Syncing...', 'syncing'); var s = await loadStock(), o = await loadOrders(); if (s && o) setStatus('‚úÖ Connected'); }
    
    function populateItemDropdown() {
        var select = document.getElementById('o-item');
        select.innerHTML = '<option value="">-- Select --</option>' + stockData.map(function(i) { return '<option value="'+i.id+'" data-size="'+i.size+'" data-price="'+i.price+'">'+i.name+' ('+i.size+'") ‚Çπ'+i.price+'</option>'; }).join('');
    }
    function getStockOptions(selected) { return '<option value="">--</option>' + stockData.map(function(s) { return '<option value="'+s.name+'"'+(selected===s.name?' selected':'')+'>'+s.name+'</option>'; }).join(''); }
    
    document.addEventListener('change', function(e) {
        if (e.target.id === 'o-item') { var opt = e.target.options[e.target.selectedIndex]; if (opt.value) { document.getElementById('o-size').value = opt.dataset.size; document.getElementById('o-amt').value = opt.dataset.price; } }
    });
    
    document.querySelectorAll('.tab-btn').forEach(function(btn) { btn.addEventListener('click', function() { document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); }); document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); }); btn.classList.add('active'); document.getElementById('tab-' + btn.dataset.tab).classList.add('active'); }); });
    document.querySelectorAll('.plat-btn').forEach(function(btn) { btn.addEventListener('click', function() { document.querySelectorAll('.plat-btn').forEach(function(b) { b.classList.remove('active'); }); btn.classList.add('active'); platform = btn.dataset.p; }); });
    document.querySelectorAll('.filter-btn').forEach(function(btn) { btn.addEventListener('click', function() { if (btn.dataset.f) { document.querySelectorAll('.filter-btn[data-f]').forEach(function(b) { b.classList.remove('active'); }); btn.classList.add('active'); filterPlat = btn.dataset.f; } if (btn.dataset.s) { if (btn.classList.contains('active')) { btn.classList.remove('active'); filterStatus = 'all'; } else { document.querySelectorAll('.filter-btn[data-s]').forEach(function(b) { b.classList.remove('active'); }); btn.classList.add('active'); filterStatus = btn.dataset.s; } } renderOrders(); }); });
    
    document.getElementById('addStockBtn').addEventListener('click', async function() {
        var name = document.getElementById('s-name').value.trim(), qty = document.getElementById('s-qty').value, cost = document.getElementById('s-cost').value, price = document.getElementById('s-price').value;
        if (!name || !qty || !cost || !price) { alert('Fill all fields'); return; }
        setStatus('üîÑ Adding...', 'syncing');
        try { await db.from('stock').insert({ name, size: document.getElementById('s-size').value, qty: parseInt(qty), cost: parseFloat(cost), price: parseFloat(price) }); document.getElementById('s-name').value = ''; document.getElementById('s-qty').value = ''; document.getElementById('s-cost').value = ''; document.getElementById('s-price').value = ''; await loadStock(); setStatus('‚úÖ Added!'); }
        catch (err) { setStatus('‚ùå ' + err.message, 'error'); }
    });
    
    window.delStock = async function(id) { if (!confirm('Delete?')) return; try { await db.from('stock').delete().eq('id', id); await loadStock(); setStatus('‚úÖ Deleted'); } catch (err) { setStatus('‚ùå ' + err.message, 'error'); } };
    window.editStock = function(id) { var item = stockData.find(function(x) { return x.id === id; }); if (!item) return; document.getElementById('edit-id').value = id; document.getElementById('edit-name').value = item.name; document.getElementById('edit-size').value = item.size; document.getElementById('edit-qty').value = item.qty; document.getElementById('edit-cost').value = item.cost; document.getElementById('edit-price').value = item.price; document.getElementById('editModal').classList.add('show'); };
    window.saveEdit = async function() { var id = parseInt(document.getElementById('edit-id').value); try { await db.from('stock').update({ name: document.getElementById('edit-name').value, size: document.getElementById('edit-size').value, qty: parseInt(document.getElementById('edit-qty').value), cost: parseFloat(document.getElementById('edit-cost').value), price: parseFloat(document.getElementById('edit-price').value) }).eq('id', id); closeModal(); await loadStock(); setStatus('‚úÖ Updated'); } catch (err) { setStatus('‚ùå ' + err.message, 'error'); } };
    window.updateQty = async function(id, val) { try { await db.from('stock').update({ qty: parseInt(val) || 0 }).eq('id', id); await loadStock(); } catch (err) { setStatus('‚ùå ' + err.message, 'error'); } };
    
    document.getElementById('addOrderBtn').addEventListener('click', async function() {
        var orderId = document.getElementById('o-id').value.trim(), itemId = document.getElementById('o-item').value, qty = parseInt(document.getElementById('o-qty').value) || 1, amt = document.getElementById('o-amt').value;
        if (!orderId || !itemId || !amt) { alert('Fill required fields'); return; }
        var stockItem = stockData.find(function(x) { return x.id === parseInt(itemId); }); if (!stockItem) return;
        if (stockItem.qty < qty) { alert('Not enough stock: ' + stockItem.qty); return; }
        setStatus('üîÑ Adding...', 'syncing');
        try {
            await db.from('orders').insert({ order_id: orderId, customer: document.getElementById('o-cust').value.trim() || null, state: document.getElementById('o-state').value.trim() || null, items: stockItem.name, size: document.getElementById('o-size').value, qty, amount: parseFloat(amt) * qty, received: parseFloat(document.getElementById('o-recv').value) || 0, platform, status: document.getElementById('o-status').value, remark: stockItem.name, order_date: document.getElementById('o-date').value || new Date().toISOString().split('T')[0] });
            await db.from('stock').update({ qty: stockItem.qty - qty }).eq('id', stockItem.id);
            document.getElementById('o-id').value = ''; document.getElementById('o-cust').value = ''; document.getElementById('o-state').value = ''; document.getElementById('o-item').value = ''; document.getElementById('o-qty').value = '1'; document.getElementById('o-amt').value = ''; document.getElementById('o-recv').value = '0';
            await loadStock(); await loadOrders(); setStatus('‚úÖ Order added!');
        } catch (err) { setStatus('‚ùå ' + err.message, 'error'); }
    });
    
    window.delOrder = async function(id) { if (!confirm('Delete?')) return; try { await db.from('orders').delete().eq('id', id); await loadOrders(); setStatus('‚úÖ Deleted'); } catch (err) { setStatus('‚ùå ' + err.message, 'error'); } };
    window.updateRemark = async function(id, val) { try { await db.from('orders').update({ remark: val || null }).eq('id', id); setStatus('‚úÖ Saved'); } catch (err) { setStatus('‚ùå ' + err.message, 'error'); } };
    window.closeModal = function() { document.querySelectorAll('.modal-bg').forEach(function(m) { m.classList.remove('show'); }); };
    
    // FILE UPLOAD - Excel AND CSV
    window.handleFileUpload = async function(input) {
        var file = input.files[0]; if (!file) return;
        var statusDiv = document.getElementById('importStatus');
        statusDiv.innerHTML = '<div class="alert alert-success">üìä Reading file...</div>';
        setStatus('üîÑ Importing...', 'syncing');
        
        var isCSV = file.name.toLowerCase().endsWith('.csv');
        var reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                var rows = [];
                
                if (isCSV) {
                    // Parse CSV
                    var text = e.target.result;
                    var lines = text.split('\n');
                    for (var i = 0; i < lines.length; i++) {
                        var row = [];
                        var line = lines[i];
                        var inQuote = false, val = '';
                        for (var j = 0; j < line.length; j++) {
                            var c = line[j];
                            if (c === '"') { inQuote = !inQuote; }
                            else if (c === ',' && !inQuote) { row.push(val.trim()); val = ''; }
                            else { val += c; }
                        }
                        row.push(val.trim());
                        if (row.length > 1) rows.push(row);
                    }
                } else {
                    // Parse Excel
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });
                    var sheetName = workbook.SheetNames.find(function(n) { return n.includes('Order'); }) || workbook.SheetNames[1] || workbook.SheetNames[0];
                    rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                }
                
                // Find header row
                var headerRow = -1;
                for (var i = 0; i < Math.min(10, rows.length); i++) {
                    var row = rows[i];
                    if (row && row.some(function(c) { return c && (c.toString().includes('Sub Order') || c.toString().includes('Order No')); })) { headerRow = i; break; }
                }
                if (headerRow === -1) { statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå No order data found</div>'; return; }
                
                var headers = rows[headerRow];
                var colMap = {};
                headers.forEach(function(h, idx) {
                    if (!h) return;
                    var hl = h.toString().toLowerCase();
                    if (hl.includes('sub order') || hl.includes('order no')) colMap.orderId = idx;
                    if (hl.includes('order date') && colMap.date === undefined) colMap.date = idx;
                    if (hl.includes('product name')) colMap.product = idx;
                    if (hl.includes('sku')) colMap.sku = idx;
                    if (hl === 'size' || hl.includes('size')) colMap.size = idx;
                    if (hl.includes('quantity')) colMap.qty = idx;
                    if (hl.includes('customer state') || hl === 'state') colMap.state = idx;
                    if (hl.includes('reason') || hl.includes('status') || hl.includes('live order')) colMap.status = idx;
                    if (hl.includes('final settlement')) colMap.received = idx;
                    if ((hl.includes('supplier') && hl.includes('price')) || (hl.includes('total sale') && !hl.includes('return'))) colMap.amount = idx;
                });
                
                var imported = 0, skipped = 0, updated = 0;
                
                for (var r = headerRow + 1; r < rows.length; r++) {
                    var row = rows[r]; if (!row || !row[colMap.orderId]) continue;
                    var orderId = row[colMap.orderId].toString().trim(); if (orderId.length < 5) continue;
                    
                    // Check existing
                    var existing = ordersData.find(function(o) { return o.order_id === orderId; });
                    
                    var status = row[colMap.status] ? row[colMap.status].toString() : 'Pending';
                    if (status.toLowerCase().includes('deliver')) status = 'Delivered';
                    else if (status.toLowerCase().includes('rto') || status.toLowerCase().includes('return')) status = 'RTO';
                    else status = 'Pending';
                    
                    var orderDate = '';
                    if (row[colMap.date]) {
                        var d = row[colMap.date];
                        if (typeof d === 'number') { orderDate = new Date((d - 25569) * 86400 * 1000).toISOString().split('T')[0]; }
                        else { orderDate = d.toString().split(' ')[0].split('T')[0]; }
                    }
                    
                    var sku = row[colMap.sku] ? row[colMap.sku].toString().trim() : '';
                    var size = row[colMap.size] ? row[colMap.size].toString().trim() : '';
                    var state = row[colMap.state] ? row[colMap.state].toString().trim() : '';
                    
                    if (existing) {
                        // Update existing order
                        try {
                            await db.from('orders').update({
                                status: status,
                                size: size || existing.size,
                                state: state || existing.state,
                                remark: sku || existing.remark
                            }).eq('id', existing.id);
                            updated++;
                        } catch (err) { }
                    } else {
                        // Insert new
                        try {
                            await db.from('orders').insert({
                                order_id: orderId,
                                items: row[colMap.product] ? row[colMap.product].toString().substring(0, 200) : '',
                                size: size,
                                qty: parseInt(row[colMap.qty]) || 1,
                                state: state,
                                amount: parseFloat(row[colMap.amount]) || 0,
                                received: parseFloat(row[colMap.received]) || 0,
                                status: status,
                                platform: 'meesho',
                                remark: sku,
                                order_date: orderDate || new Date().toISOString().split('T')[0]
                            });
                            imported++;
                        } catch (err) { skipped++; }
                    }
                }
                
                await loadOrders();
                statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ New: <b>' + imported + '</b> | Updated: <b>' + updated + '</b> | Skipped: <b>' + skipped + '</b></div>';
                setStatus('‚úÖ Import done!'); input.value = '';
            } catch (err) { statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå ' + err.message + '</div>'; setStatus('‚ùå Failed', 'error'); }
        };
        
        if (isCSV) { reader.readAsText(file); } else { reader.readAsArrayBuffer(file); }
    };
    
    window.exportData = function() {
        var csv = 'Type,Name,SKU,Size,Qty,State,Status,Amount,Received\n';
        stockData.forEach(function(s) { csv += 'Stock,"'+s.name+'",,'+s.size+','+s.qty+',,,' +s.cost+','+s.price+'\n'; });
        ordersData.forEach(function(o) { csv += 'Order,"'+o.order_id+'","'+(o.remark||'')+'",'+(o.size||'')+','+(o.qty||1)+','+(o.state||'')+','+(o.status||'')+','+o.amount+','+o.received+'\n'; });
        var a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = 'glass-hut-'+new Date().toISOString().split('T')[0]+'.csv'; a.click();
    };
    
    function renderDashboard() {
        var stockVal = stockData.reduce(function(s, x) { return s + (x.qty * x.cost); }, 0);
        var sales = ordersData.reduce(function(s, x) { return s + x.amount; }, 0);
        var recv = ordersData.reduce(function(s, x) { return s + x.received; }, 0);
        var delivered = ordersData.filter(function(x) { return x.status === 'Delivered'; }).length;
        var rto = ordersData.filter(function(x) { return x.status === 'RTO'; }).length;
        var lowStock = stockData.filter(function(x) { return x.qty <= 20; });
        document.getElementById('d-stock').textContent = '‚Çπ' + stockVal.toLocaleString();
        document.getElementById('d-sales').textContent = '‚Çπ' + sales.toLocaleString();
        document.getElementById('d-recv').textContent = '‚Çπ' + recv.toLocaleString();
        document.getElementById('d-del').textContent = delivered;
        document.getElementById('d-rto').textContent = rto;
        document.getElementById('alertBox').innerHTML = lowStock.length > 0 ? '<div class="alert alert-danger">‚ö†Ô∏è Low: ' + lowStock.map(function(x) { return x.name + '(' + x.qty + ')'; }).join(', ') + '</div>' : '';
        document.getElementById('dashLow').innerHTML = lowStock.length > 0 ? lowStock.slice(0,5).map(function(x) { return '<div style="display:flex;justify-content:space-between;padding:0.25rem 0;border-bottom:1px solid #fef3c7;font-size:0.75rem"><span>'+x.name+'</span><span style="color:#dc2626">'+x.qty+'</span></div>'; }).join('') : '<div class="empty">All OK ‚úÖ</div>';
        document.getElementById('dashRecent').innerHTML = ordersData.length > 0 ? ordersData.slice(0,5).map(function(x) { return '<div style="display:flex;justify-content:space-between;padding:0.25rem 0;border-bottom:1px solid #fef3c7;font-size:0.7rem"><span>'+(x.remark||x.order_id.substring(0,10)+'..')+' <span class="badge badge-'+(x.status||'pending').toLowerCase()+'">'+(x.status||'?')+'</span></span><span>‚Çπ'+x.amount+'</span></div>'; }).join('') : '<div class="empty">No orders</div>';
    }
    
    function renderStock() {
        document.getElementById('stockCnt').textContent = stockData.length;
        document.getElementById('stockTbl').innerHTML = stockData.length > 0 ? stockData.map(function(x) {
            var isLow = x.qty <= 20;
            return '<tr class="'+(isLow?'low-stock':'')+'"><td><b>'+x.name+'</b></td><td>'+x.size+'"</td><td><input type="number" class="qty-input" value="'+x.qty+'" onchange="updateQty('+x.id+',this.value)" min="0" style="'+(isLow?'color:#dc2626;font-weight:600':'')+'"></td><td>‚Çπ'+x.cost+'</td><td style="color:#059669">‚Çπ'+x.price+'</td><td style="font-weight:600">‚Çπ'+(x.qty*x.cost).toLocaleString()+'</td><td><button class="act-btn edit" onclick="editStock('+x.id+')">‚úèÔ∏è</button><button class="act-btn del" onclick="delStock('+x.id+')">üóëÔ∏è</button></td></tr>';
        }).join('') : '<tr><td colspan="7" class="empty">No stock</td></tr>';
    }
    
    function renderOrders() {
        var filtered = ordersData;
        if (filterPlat !== 'all') filtered = filtered.filter(function(x) { return x.platform === filterPlat; });
        if (filterStatus !== 'all') filtered = filtered.filter(function(x) { return x.status === filterStatus; });
        document.getElementById('ordCnt').textContent = filtered.length;
        document.getElementById('ordTbl').innerHTML = filtered.length > 0 ? filtered.map(function(x) {
            var shortProduct = x.items ? (x.items.length > 18 ? x.items.substring(0,18)+'..' : x.items) : '-';
            return '<tr>' +
                '<td style="font-size:0.55rem;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+x.order_id+'">'+x.order_id+'</td>' +
                '<td class="product-cell"><span class="product-short" title="'+(x.items||'')+'">'+shortProduct+'</span></td>' +
                '<td><select class="remark-select" onchange="updateRemark('+x.id+',this.value)">'+getStockOptions(x.remark)+'</select></td>' +
                '<td>'+(x.size||'-')+'"</td>' +
                '<td>'+(x.qty||1)+'</td>' +
                '<td style="font-size:0.55rem">'+(x.state||'-')+'</td>' +
                '<td><span class="badge badge-'+x.platform+'">'+x.platform+'</span></td>' +
                '<td><span class="badge badge-'+(x.status||'pending').toLowerCase()+'">'+(x.status||'?')+'</span></td>' +
                '<td style="font-size:0.55rem">'+x.order_date+'</td>' +
                '<td style="font-weight:600">‚Çπ'+x.amount.toLocaleString()+'</td>' +
                '<td style="color:#059669">‚Çπ'+x.received.toLocaleString()+'</td>' +
                '<td><button class="act-btn del" onclick="delOrder('+x.id+')">üóëÔ∏è</button></td></tr>';
        }).join('') : '<tr><td colspan="12" class="empty">No orders</td></tr>';
    }
    
    document.addEventListener('DOMContentLoaded', function() { checkAuth(); });
    document.getElementById('loginPassword').addEventListener('keypress', function(e) { if (e.key === 'Enter') doLogin(); });
    document.getElementById('loginEmail').addEventListener('keypress', function(e) { if (e.key === 'Enter') document.getElementById('loginPassword').focus(); });
    
    var uploadBox = document.querySelector('.upload-box');
    if (uploadBox) {
        uploadBox.addEventListener('dragover', function(e) { e.preventDefault(); uploadBox.style.borderColor = '#f59e0b'; });
        uploadBox.addEventListener('dragleave', function(e) { e.preventDefault(); uploadBox.style.borderColor = '#fcd34d'; });
        uploadBox.addEventListener('drop', function(e) { e.preventDefault(); uploadBox.style.borderColor = '#fcd34d'; if (e.dataTransfer.files.length > 0) { document.getElementById('excelFile').files = e.dataTransfer.files; handleFileUpload(document.getElementById('excelFile')); } });
    }
    </script>
</body>
</html>
